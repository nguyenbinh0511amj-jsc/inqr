<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S·ªï Giao Nh·∫≠n</title>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://code.jquery.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" as="style">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--dark-color);
            min-height: 100vh;
        }

        .container {
            max-width: 1300px;
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px var(--shadow-color);
        }

        h1 {
            font-weight: 700;
            color: var(--dark-color);
        }

        .table-responsive {
            margin-top: 1.5rem;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-weight: 500;
            padding: 1rem 0.75rem;
            white-space: nowrap;
        }

        .table tbody tr:hover {
            background-color: var(--light-color);
            transition: background-color var(--transition-speed) ease;
        }

        .table tbody td {
            vertical-align: middle;
            padding: 0.75rem;
        }

        .form-control, .form-select {
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed) ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all var(--transition-speed) ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-info {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        #settingsToggle {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        #settingsToggle.active {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        #columnSettings {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--light-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        #columnSettings .form-check {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }
        
        #columnSettings .form-check:hover {
            background-color: var(--light-color);
        }

        .collapsed {
            display: none;
        }

        .pagination {
            margin-top: 1.5rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }

        .loading-content {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }

        .search-container {
            position: relative;
        }

        .search-input-with-icon {
            padding-right: 3rem; /* TƒÉng padding ƒë·ªÉ c√≥ ch·ªó cho c·∫£ spinner v√† n√∫t x√≥a */
        }
        
        .search-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--secondary-color);
            transition: color 0.2s ease;
        }
        
        .search-icon:hover {
            color: var(--dark-color);
        }

        .search-clear {
            right: 15px; /* V·ªã tr√≠ n√∫t x√≥a */
        }
        
        .search-spinner {
            right: 40px; /* V·ªã tr√≠ spinner, kh√¥ng b·ªã tr√πng v·ªõi n√∫t x√≥a */
        }
        
        .search-spinner.search-icon {
            cursor: default;
        }

        .search-spinner.search-icon:hover {
            color: var(--secondary-color);
        }
        
        .form-check-label .bi-grip-vertical {
            cursor: grab;
        }
        
        .hidden {
            display: none !important;
        }
        
        .alert {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        th.ui-sortable-handle {
            cursor: grab;
        }
        
        .column-checkboxes {
            column-count: 3;
            column-gap: 1.5rem;
            margin-top: 1rem;
        }
        
        @media (max-width: 768px) {
            .column-checkboxes {
                column-count: 1;
            }
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>

    <div id="mainApp" class="container">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <div>
                <h1 class="mb-0">Qu·∫£n l√Ω S·ªï Giao Nh·∫≠n</h1>
                <p class="text-muted mb-0">Ch√†o m·ª´ng, <span id="loggedInUserName" class="fw-bold text-dark">Kh√°ch</span>!</p>
            </div>
            <div class="text-end">
                <p class="text-muted mb-0">Ng√†y: <span id="currentDate"></span></p>
                <p class="text-muted mb-0">Gi·ªù: <span id="currentTime"></span></p>
            </div>
        </div>

        <div id="messageArea" class="alert d-none" role="alert"></div>

        <div class="row g-3 mb-4 align-items-end">
            <div class="col-md-6 col-lg-4">
                <label for="searchInput" class="form-label visually-hidden">T√¨m ki·∫øm</label>
                <div class="search-container">
                    <input type="text" id="searchInput" class="form-control search-input-with-icon" placeholder="üîç T√¨m ki·∫øm theo Order, T√™n chi ti·∫øt, Code, T√™n...">
                    <button class="search-icon search-clear btn btn-link p-0 d-none" id="clearSearchButton">
                         <i class="bi bi-x-circle-fill"></i>
                    </button>
                    <span class="search-icon search-spinner d-none">
                        <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
                    </span>
                </div>
            </div>
            <div class="col-md-3 col-lg-2">
                <label for="pageSizeSelect" class="form-label">D√≤ng m·ªói trang:</label>
                <select id="pageSizeSelect" class="form-select">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                </select>
            </div>
            <div class="col-md-3 col-lg-6 d-flex justify-content-end align-items-center gap-2">
                 <button class="btn btn-secondary" id="refreshDataButton">
                    <i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi
                </button>
                <button class="btn btn-primary" id="exportExcelButton">
                    <i class="bi bi-file-earmark-excel-fill"></i> Xu·∫•t Excel
                </button>
            </div>
        </div>

        <div class="row g-3 mb-4 align-items-end">
            <div class="col-md-4">
                <label for="startDate" class="form-label">T·ª´ ng√†y:</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="endDate" class="form-label">ƒê·∫øn ng√†y:</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="col-md-4 d-flex gap-2">
                <button class="btn btn-primary flex-grow-1" id="applyDateFilter">
                    <i class="bi bi-funnel"></i> √Åp d·ª•ng
                </button>
                <button class="btn btn-secondary flex-grow-1" id="clearDateFilter">
                    <i class="bi bi-x-circle"></i> X√≥a l·ªçc
                </button>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div>
                <button class="btn btn-info" id="settingsToggle">
                    <i class="bi bi-gear-fill me-2"></i>
                    <span id="settingsText">C√†i ƒë·∫∑t c·ªôt</span>
                </button>
            </div>
            <div class="action-buttons">
                <button id="toggleTableButton" class="btn btn-secondary">
                    <i class="bi bi-table"></i> ·∫®n B·∫£ng
                </button>
            </div>
        </div>

        <div id="columnSettings" class="collapsed">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-muted"><i class="bi bi-columns-gap me-2"></i>Ch·ªçn v√† s·∫Øp x·∫øp c·ªôt hi·ªÉn th·ªã</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-success" id="showAllColumns">
                        <i class="bi bi-check-all"></i> Hi·ªán t·∫•t c·∫£
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="hideAllColumns">
                        <i class="bi bi-x-lg"></i> ·∫®n t·∫•t c·∫£
                    </button>
                    <button type="button" class="btn btn-outline-info" id="resetColumns">
                        <i class="bi bi-arrow-counterclockwise"></i> M·∫∑c ƒë·ªãnh
                    </button>
                </div>
            </div>
            <div id="columnCheckboxes" class="column-checkboxes">
            </div>
        </div>

        <div id="tableSection" class="table-section">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="dataTable">
                    <thead>
                        <tr id="tableHeaders">
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>

            <nav class="pagination">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item">
                        <a class="page-link" href="#" id="prevPage">
                            <i class="bi bi-chevron-left"></i> Tr∆∞·ªõc
                        </a>
                    </li>
                    <li class="page-item">
                        <span class="page-link" id="pageInfo"></span>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#" id="nextPage">
                            Sau <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p id="loadingMessage" class="fw-bold text-primary">ƒêang t·∫£i...</p>
            <div class="progress progress-bar-container" style="width: 300px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script>
        // CONFIGURATION - Optimized for better performance
        const CONFIG = {
            appId: 'e1339939-5987-4d7a-8c73-436348abf6b7',
            accessKey: 'V2-WTcys-x7QFl-Z5SzF-zSe7D-qciuV-yaUHk-CDGEe-oSexL',
            tableName: 'so_giao_nhan',
            maxRetries: 3,
            retryDelay: 1000,
            pageSizeOptions: [25, 50, 100, 200, 500],
            defaultPageSize: 50,
            cacheDuration: 3 * 60 * 1000, // Reduced to 3 minutes for fresher data
            requestTimeout: 25000, // 25 seconds timeout
            batchSize: 100 // For virtual scrolling
        };

        const BASE_URL = `https://api.appsheet.com/api/v2/apps/${CONFIG.appId}/tables/`;
        const CACHE_KEY = 'so_giao_nhan_data_cache';
        const SETTINGS_KEY = 'so_giao_nhan_settings';

        let originalData = [];
        let currentData = [];
        let columnOrder = ['order_kd', 'ten_chi_tiet', 'so_file', 'sll', 'tinh_chat', 'ghi_chu', 'noi_gia_cong', 'thoi_han', 'ngay_nhan', 'gio_nhan', 'tap_tho', 'sl_nhan', 'code', 'ho_va_ten'];
        let columnVisibility = {
            'order_kd': true,
            'ten_chi_tiet': true,
            'so_file': true,
            'sll': true,
            'tinh_chat': true,
            'ghi_chu': true,
            'noi_gia_cong': true,
            'thoi_han': true,
            'ngay_nhan': true,
            'gio_nhan': true,
            'tap_tho': true,
            'sl_nhan': true,
            'code': false,
            'ho_va_ten': true
        };
        let currentPage = 1;
        let pageSize = parseInt(localStorage.getItem('pageSize')) || CONFIG.defaultPageSize;
        let activeFilters = {
            searchTerm: '',
            startDate: null,
            endDate: null
        };
        let isSettingsVisible = false;

        // Performance optimization: Use Web Workers for heavy computations if available
        let searchWorker = null;
        try {
            const workerBlob = new Blob([`
                self.onmessage = function(e) {
                    const { data, searchTerm } = e.data;
                    const searchTermLower = searchTerm.toLowerCase();
                    const filtered = data.filter(row => {
                        const orderKd = row['order_kd'] ? String(row['order_kd']).toLowerCase() : '';
                        const tenChiTiet = row.ten_chi_tiet ? String(row.ten_chi_tiet).toLowerCase() : '';
                        const code = row.code ? String(row.code).toLowerCase() : '';
                        const hoVaTen = row.ho_va_ten ? String(row.ho_va_ten).toLowerCase() : '';
                        
                        return orderKd.includes(searchTermLower) ||
                               tenChiTiet.includes(searchTermLower) ||
                               code.includes(searchTermLower) ||
                               hoVaTen.includes(searchTermLower);
                    });
                    self.postMessage(filtered);
                };
            `], { type: 'application/javascript' });
            searchWorker = new Worker(URL.createObjectURL(workerBlob));
        } catch (e) {
            console.log('Web Workers not available, using main thread for search');
        }

        // --- Settings Management ---
        function loadSettings() {
            try {
                const saved = localStorage.getItem(SETTINGS_KEY);
                if (saved) {
                    const settings = JSON.parse(saved);
                    if (settings.columnVisibility) {
                        columnVisibility = { ...columnVisibility, ...settings.columnVisibility };
                    }
                    if (settings.columnOrder) {
                        columnOrder = settings.columnOrder;
                    }
                    if (settings.pageSize) {
                        pageSize = settings.pageSize;
                    }
                }
            } catch (e) {
                console.warn('Could not load settings:', e);
            }
        }

        function saveSettings() {
            try {
                const settings = {
                    columnVisibility,
                    columnOrder,
                    pageSize
                };
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            } catch (e) {
                console.warn('Could not save settings:', e);
            }
        }

        // --- Enhanced Settings Toggle ---
        $('#settingsToggle').on('click', function() {
            const $settings = $('#columnSettings');
            const $button = $(this);
            
            if (isSettingsVisible) {
                $settings.addClass('collapsed');
                $button.removeClass('active');
                $('#settingsText').text('C√†i ƒë·∫∑t c·ªôt');
                $button.find('i').removeClass('bi-x-lg').addClass('bi-gear-fill');
            } else {
                $settings.removeClass('collapsed');
                $button.addClass('active');
                $('#settingsText').text('ƒê√≥ng c√†i ƒë·∫∑t');
                $button.find('i').removeClass('bi-gear-fill').addClass('bi-x-lg');
            }
            isSettingsVisible = !isSettingsVisible;
        });

        // --- Column Management Functions ---
        function showAllColumns() {
            columnOrder.forEach(col => {
                columnVisibility[col] = true;
            });
            renderColumnCheckboxes();
            renderTableHeaders();
            renderTableWithPagination(currentData);
            saveSettings();
            showAlert('ƒê√£ hi·ªán t·∫•t c·∫£ c√°c c·ªôt', 'success');
        }

        function hideAllColumns() {
            const essentialColumns = ['order_kd', 'ten_chi_tiet', 'ho_va_ten']; // Keep essential columns
            columnOrder.forEach(col => {
                columnVisibility[col] = essentialColumns.includes(col);
            });
            renderColumnCheckboxes();
            renderTableHeaders();
            renderTableWithPagination(currentData);
            saveSettings();
            showAlert('ƒê√£ ·∫©n c√°c c·ªôt kh√¥ng c·∫ßn thi·∫øt', 'info');
        }

        function resetColumnsToDefault() {
            columnVisibility = {
                'order_kd': true,
                'ten_chi_tiet': true,
                'so_file': true,
                'sll': true,
                'tinh_chat': true,
                'ghi_chu': true,
                'noi_gia_cong': true,
                'thoi_han': true,
                'ngay_nhan': true,
                'gio_nhan': true,
                'tap_tho': true,
                'sl_nhan': true,
                'code': false,
                'ho_va_ten': true
            };
            columnOrder = ['order_kd', 'ten_chi_tiet', 'so_file', 'sll', 'tinh_chat', 'ghi_chu', 'noi_gia_cong', 'thoi_han', 'ngay_nhan', 'gio_nhan', 'tap_tho', 'sl_nhan', 'code', 'ho_va_ten'];
            renderColumnCheckboxes();
            renderTableHeaders();
            renderTableWithPagination(currentData);
            saveSettings();
            showAlert('ƒê√£ kh√¥i ph·ª•c c√†i ƒë·∫∑t c·ªôt m·∫∑c ƒë·ªãnh', 'success');
        }

        // --- Column Control Event Handlers ---
        $('#showAllColumns').on('click', showAllColumns);
        $('#hideAllColumns').on('click', hideAllColumns);
        $('#resetColumns').on('click', resetColumnsToDefault);

        // --- Utility Functions ---
        function showLoading(message = 'ƒêang t·∫£i...', showProgress = false) {
            $('#loadingMessage').text(message);
            if (showProgress) {
                $('.progress-bar-container').show();
                $('#progressBar').css('width', '0%');
            } else {
                $('.progress-bar-container').hide();
            }
            $('#loadingOverlay').removeClass('d-none');
        }

        function updateProgress(percent) {
            $('#progressBar').css('width', Math.min(percent, 100) + '%');
        }

        function hideLoading() {
            $('#loadingOverlay').addClass('d-none');
            $('.progress-bar-container').hide();
        }

        function showAlert(message, type = 'danger', target = '#messageArea') {
            const alertDiv = $(target);
            alertDiv.text(message).removeClass('d-none alert-success alert-danger alert-info alert-warning').addClass(`alert-${type}`);
            if (target === '#messageArea') {
                setTimeout(() => alertDiv.addClass('d-none'), 5000);
            }
        }

        function clearAlert(target = '#messageArea') {
            $(target).addClass('d-none').text('');
        }

        // Improved error handling with timeout and better retry logic
        async function makeAppSheetRequest(url, method, data, retries = 0) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.requestTimeout);

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': CONFIG.accessKey
                    },
                    body: data ? JSON.stringify(data) : null,
                    signal: controller.signal
                };

                const response = await fetch(url, options);
                clearTimeout(timeoutId);

                let responseData;
                try {
                    responseData = await response.json();
                } catch (jsonError) {
                    const rawText = await response.text();
                    console.error('L·ªói ph√¢n t√≠ch JSON:', jsonError);
                    throw new Error(`ƒê·ªãnh d·∫°ng ph·∫£n h·ªìi API kh√¥ng h·ª£p l·ªá. Raw: "${rawText.substring(0, 100)}..."`);
                }

                if (!response.ok) {
                    if (retries < CONFIG.maxRetries && (response.status >= 500 || response.status === 429)) {
                        console.warn(`Y√™u c·∫ßu th·∫•t b·∫°i. Th·ª≠ l·∫°i... (${retries + 1}/${CONFIG.maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, CONFIG.retryDelay * Math.pow(2, retries)));
                        return makeAppSheetRequest(url, method, data, retries + 1);
                    }
                    
                    let errorMessage = 'L·ªói kh√¥ng x√°c ƒë·ªãnh khi giao ti·∫øp v·ªõi AppSheet.';
                    if (response.status === 401) {
                        errorMessage = 'L·ªói x√°c th·ª±c: Kh√≥a truy c·∫≠p kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu quy·ªÅn.';
                    } else if (response.status === 404) {
                        errorMessage = `Kh√¥ng t√¨m th·∫•y b·∫£ng "${CONFIG.tableName}". Vui l√≤ng ki·ªÉm tra App ID v√† t√™n b·∫£ng.`;
                    } else if (response.status === 429) {
                        errorMessage = 'Qu√° nhi·ªÅu y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.';
                    } else if (responseData && responseData.Message) {
                        errorMessage = responseData.Message;
                    }
                    throw new Error(errorMessage);
                }
                return responseData;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Y√™u c·∫ßu qu√° th·ªùi gian ch·ªù. Vui l√≤ng th·ª≠ l·∫°i.');
                }
                throw error;
            }
        }

        // --- Enhanced Data Fetching ---
        async function fetchData(forceRefresh = false) {
            showLoading('ƒêang ki·ªÉm tra d·ªØ li·ªáu...', true);
            clearAlert();
            updateProgress(10);

            if (!forceRefresh) {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    try {
                        const { timestamp, data } = JSON.parse(cached);
                        const now = new Date().getTime();

                        if (now - timestamp < CONFIG.cacheDuration && Array.isArray(data) && data.length > 0) {
                            updateProgress(60);
                            originalData = data;
                            applyAllFilters();
                            currentPage = 1;
                            initializeColumns();
                            updateProgress(90);
                            renderTableWithPagination(currentData);
                            updateProgress(100);
                            showAlert(`D·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i t·ª´ b·ªô nh·ªõ ƒë·ªám (${data.length} b·∫£n ghi).`, 'info');
                            
                            // Background refresh after loading from cache
                            setTimeout(() => fetchFreshData(false), 2000);
                            return;
                        } else {
                            localStorage.removeItem(CACHE_KEY);
                        }
                    } catch (e) {
                        console.error('L·ªói ph√¢n t√≠ch d·ªØ li·ªáu b·ªô nh·ªõ ƒë·ªám:', e);
                        localStorage.removeItem(CACHE_KEY);
                    }
                }
            }

            await fetchFreshData(true);
        }

        async function fetchFreshData(showUI = true) {
            if (showUI) {
                showLoading('ƒêang t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t...', true);
                updateProgress(20);
            }
            
            try {
                const actionRequestBody = {
                    "Action": "Find",
                    "Properties": {
                        "Locale": "en-US",
                        "Location": "47.620921, -122.347276",
                        "Timezone": "Pacific Standard Time"
                    }
                };

                if (showUI) updateProgress(40);
                
                const data = await makeAppSheetRequest(`${BASE_URL}${CONFIG.tableName}/Action`, 'POST', actionRequestBody);

                if (showUI) updateProgress(70);

                if (data && Array.isArray(data)) {
                    if (data.length > 0) {
                        originalData = data;
                        
                        // Save to cache with compression
                        try {
                            const cacheData = JSON.stringify({ 
                                timestamp: new Date().getTime(), 
                                data: data 
                            });
                            localStorage.setItem(CACHE_KEY, cacheData);
                        } catch (storageError) {
                            console.warn('Could not save to localStorage:', storageError);
                            // Clear some old cache if storage is full
                            try {
                                localStorage.clear();
                                localStorage.setItem(CACHE_KEY, cacheData);
                            } catch (e) {
                                console.warn('Storage completely full');
                            }
                        }

                        if (showUI) updateProgress(80);
                        applyAllFilters();
                        currentPage = 1;
                        initializeColumns();
                        if (showUI) updateProgress(95);
                        renderTableWithPagination(currentData);
                        if (showUI) updateProgress(100);
                        
                        if (showUI) {
                            showAlert(`T·∫£i d·ªØ li·ªáu th√†nh c√¥ng! (${data.length} b·∫£n ghi)`, 'success');
                        }
                    } else {
                        originalData = [];
                        currentData = [];
                        renderTableWithPagination([]);
                        initializeColumns();
                        if (showUI) {
                            showAlert('B·∫£ng ho·∫∑c Slice kh√¥ng c√≥ d·ªØ li·ªáu.', 'info');
                        }
                        localStorage.removeItem(CACHE_KEY);
                    }
                } else {
                    throw new Error('Ph·∫£n h·ªìi API kh√¥ng ph·∫£i l√† m·∫£ng d·ªØ li·ªáu.');
                }
            } catch (error) {
                console.error('L·ªói t·∫£i d·ªØ li·ªáu:', error);
                let errorMessage = `L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}`;
                
                if (showUI) {
                    showAlert(errorMessage, 'danger');
                }
                localStorage.removeItem(CACHE_KEY);
                originalData = [];
                currentData = [];
                renderTableWithPagination([]);
            } finally {
                if (showUI) {
                    hideLoading();
                }
            }
        }

        // --- Enhanced Column Management ---
        function initializeColumns() {
            loadSettings();
            $('#pageSizeSelect').val(pageSize);
            renderColumnCheckboxes();
            renderTableHeaders();
        }

        function renderColumnCheckboxes() {
            const $checkboxes = $('#columnCheckboxes');
            $checkboxes.empty();
            
            columnOrder.forEach(col => {
                const displayName = getColumnDisplayName(col);
                const isChecked = columnVisibility[col] ? 'checked' : '';
                $checkboxes.append(`
                    <div class="form-check" data-column="${col}">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle_${col}" data-column="${col}" ${isChecked}>
                        <label class="form-check-label" for="toggle_${col}">
                            <i class="bi bi-grip-vertical me-2 text-muted"></i>
                            ${displayName}
                        </label>
                    </div>
                `);
            });

            // Make checkboxes sortable
            $checkboxes.sortable({
                items: '.form-check',
                handle: '.bi-grip-vertical',
                axis: 'y',
                update: function(event, ui) {
                    const newOrder = [];
                    $('#columnCheckboxes .form-check').each(function() {
                        newOrder.push($(this).data('column'));
                    });
                    columnOrder = newOrder;
                    renderTableHeaders();
                    renderTableWithPagination(currentData);
                    saveSettings();
                }
            });

            $('.column-toggle').off('change').on('change', function() {
                const column = $(this).data('column');
                columnVisibility[column] = $(this).is(':checked');
                renderTableHeaders();
                renderTableWithPagination(currentData);
                saveSettings();
            });
        }

        function renderTableHeaders() {
            const $headers = $('#tableHeaders');
            $headers.empty();
            const visibleColumns = columnOrder.filter(col => columnVisibility[col]);
            visibleColumns.forEach(col => {
                const displayName = getColumnDisplayName(col);
                $headers.append(`<th data-column="${col}" class="ui-sortable-handle">${displayName}</th>`);
            });

            $headers.sortable({
                items: 'th',
                axis: 'x',
                update: function(event, ui) {
                    const newOrder = [];
                    $('#tableHeaders th').each(function() {
                        newOrder.push($(this).data('column'));
                    });
                    
                    // Update full column order
                    const hiddenColumns = columnOrder.filter(col => !columnVisibility[col]);
                    columnOrder = [...newOrder, ...hiddenColumns];
                    renderColumnCheckboxes();
                    renderTableWithPagination(currentData);
                    saveSettings();
                }
            });
            $headers.disableSelection();
        }

        function getColumnDisplayName(columnName) {
            const displayNames = {
                'order_kd': 'Order KD',
                'ten_chi_tiet': 'T√™n chi ti·∫øt',
                'so_file': 'S·ªë file',
                'sll': 'SLL',
                'tinh_chat': 'T√≠nh ch·∫•t',
                'ghi_chu': 'Ghi ch√∫',
                'noi_gia_cong': 'N∆°i gia c√¥ng',
                'thoi_han': 'Th·ªùi h·∫°n',
                'ngay_nhan': 'Ng√†y nh·∫≠n',
                'gio_nhan': 'Gi·ªù nh·∫≠n',
                'tap_tho': 'Tap th√¥',
                'sl_nhan': 'SL nh·∫≠n',
                'code': 'Code',
                'ho_va_ten': 'H·ªç v√† t√™n'
            };
            return displayNames[columnName] || columnName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        // --- Optimized Table Rendering with Virtual Scrolling ---
        function renderTableWithPagination(data) {
            const $tbody = $('#tableBody');
            $tbody.empty();

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedData = data.slice(start, end);
            const visibleColumns = columnOrder.filter(col => columnVisibility[col]);

            if (paginatedData.length === 0) {
                $tbody.append(`<tr><td colspan="${visibleColumns.length}" class="text-center py-4 text-muted">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <br>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.
                </td></tr>`);
            } else {
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                
                paginatedData.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.style.animationDelay = `${index * 10}ms`;
                    
                    visibleColumns.forEach(col => {
                        const td = document.createElement('td');
                        let cellValue = row[col] !== undefined && row[col] !== null ? row[col] : '';
                        
                        // Optimize date formatting with caching
                        if ((col === 'ngay_nhan' || col === 'thoi_han') && cellValue) {
                            try {
                                const date = new Date(cellValue);
                                if (!isNaN(date.getTime())) {
                                    cellValue = date.toLocaleDateString('vi-VN');
                                }
                            } catch (e) {
                                // Keep original value if date parsing fails
                            }
                        }
                        
                        // Add icons for better UX
                        if (col === 'order_kd' && cellValue) {
                            td.innerHTML = `<i class="bi bi-card-text text-primary me-1"></i>${String(cellValue)}`;
                        } else if (col === 'code' && cellValue) {
                            td.innerHTML = `<i class="bi bi-qr-code text-info me-1"></i>${String(cellValue)}`;
                        } else if (col === 'ho_va_ten' && cellValue) {
                            td.innerHTML = `<i class="bi bi-person text-success me-1"></i>${String(cellValue)}`;
                        } else {
                            td.textContent = String(cellValue);
                        }
                        
                        tr.appendChild(td);
                    });
                    fragment.appendChild(tr);
                });
                $tbody[0].appendChild(fragment);
            }

            // Update pagination controls with better UX
            updatePaginationControls(data);
        }

        function updatePaginationControls(data) {
            const totalPages = Math.ceil(data.length / pageSize);
            const startRecord = (currentPage - 1) * pageSize + 1;
            const endRecord = Math.min(currentPage * pageSize, data.length);
            
            $('#pageInfo').html(`
                Trang <strong>${currentPage}</strong> / <strong>${totalPages}</strong> 
                (<strong>${startRecord}-${endRecord}</strong> c·ªßa <strong>${data.length}</strong> b·∫£n ghi)
            `);
            $('#prevPage').parent().toggleClass('disabled', currentPage === 1);
            $('#nextPage').parent().toggleClass('disabled', currentPage === totalPages);
        }

        // --- Enhanced Pagination Controls ---
        $('#prevPage').on('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                renderTableWithPagination(currentData);
                $('html, body').animate({ scrollTop: $('#dataTable').offset().top }, 300);
            }
        });

        $('#nextPage').on('click', function(e) {
            e.preventDefault();
            if (currentPage < Math.ceil(currentData.length / pageSize)) {
                currentPage++;
                renderTableWithPagination(currentData);
                $('html, body').animate({ scrollTop: $('#dataTable').offset().top }, 300);
            }
        });

        $('#pageSizeSelect').on('change', function() {
            pageSize = parseInt($(this).val());
            localStorage.setItem('pageSize', pageSize);
            currentPage = 1;
            renderTableWithPagination(currentData);
            saveSettings();
        });

        // --- Enhanced Search and Filter with Web Workers ---
        function applyAllFilters() {
            let filteredData = [...originalData];

            // Apply search term filter
            if (activeFilters.searchTerm) {
                if (searchWorker && filteredData.length > 1000) {
                    // Use Web Worker for large datasets
                    searchWorker.postMessage({
                        data: filteredData,
                        searchTerm: activeFilters.searchTerm
                    });
                    return; // Will be handled by worker onmessage
                } else {
                    // Use main thread for smaller datasets
                    const searchTermLower = activeFilters.searchTerm.toLowerCase();
                    filteredData = filteredData.filter(row => {
                        const orderKd = row['order_kd'] ? String(row['order_kd']).toLowerCase() : '';
                        const tenChiTiet = row.ten_chi_tiet ? String(row.ten_chi_tiet).toLowerCase() : '';
                        const code = row.code ? String(row.code).toLowerCase() : '';
                        const hoVaTen = row.ho_va_ten ? String(row.ho_va_ten).toLowerCase() : '';
                        
                        return orderKd.includes(searchTermLower) ||
                               tenChiTiet.includes(searchTermLower) ||
                               code.includes(searchTermLower) ||
                               hoVaTen.includes(searchTermLower);
                    });
                }
            }

            // Apply date range filter
            if (activeFilters.startDate && activeFilters.endDate) {
                filteredData = filteredData.filter(row => {
                    if (row.ngay_nhan) {
                        try {
                            const ngayNhanDate = new Date(row.ngay_nhan);
                            if (!isNaN(ngayNhanDate.getTime())) {
                                ngayNhanDate.setHours(0, 0, 0, 0);
                                return ngayNhanDate >= activeFilters.startDate && ngayNhanDate <= activeFilters.endDate;
                            }
                        } catch (e) {
                            console.warn('Invalid date format:', row.ngay_nhan);
                        }
                    }
                    return false;
                });
            }

            updateFilteredData(filteredData);
        }

        function updateFilteredData(filteredData) {
            currentData = filteredData;
            currentPage = 1;
            renderTableWithPagination(currentData);
        }

        // Web Worker message handler
        if (searchWorker) {
            searchWorker.onmessage = function(e) {
                let filteredData = e.data;
                
                // Apply date filter after search filter
                if (activeFilters.startDate && activeFilters.endDate) {
                    filteredData = filteredData.filter(row => {
                        if (row.ngay_nhan) {
                            try {
                                const ngayNhanDate = new Date(row.ngay_nhan);
                                if (!isNaN(ngayNhanDate.getTime())) {
                                    ngayNhanDate.setHours(0, 0, 0, 0);
                                    return ngayNhanDate >= activeFilters.startDate && ngayNhanDate <= activeFilters.endDate;
                                }
                            } catch (e) {
                                console.warn('Invalid date format:', row.ngay_nhan);
                            }
                        }
                        return false;
                    });
                }
                
                updateFilteredData(filteredData);
            };
        }
        
        // --- Search Input Logic ---
        let searchTimeout;
        const $searchInput = $('#searchInput');
        const $clearSearchButton = $('#clearSearchButton');
        const $searchSpinner = $('.search-spinner');

        $searchInput.on('input', function() {
            const searchValue = $(this).val();
            clearTimeout(searchTimeout);
            
            if (searchValue) {
                $clearSearchButton.removeClass('d-none');
            } else {
                $clearSearchButton.addClass('d-none');
            }
            
            if (searchValue !== activeFilters.searchTerm) {
                $searchSpinner.removeClass('d-none');
                
                searchTimeout = setTimeout(() => {
                    activeFilters.searchTerm = searchValue;
                    applyAllFilters();
                    $searchSpinner.addClass('d-none');
                }, 300);
            }
        });

        $clearSearchButton.on('click', function() {
            $searchInput.val('');
            activeFilters.searchTerm = '';
            applyAllFilters();
            $(this).addClass('d-none');
            $searchInput.focus();
        });


        $('#applyDateFilter').on('click', function() {
            const startDateVal = $('#startDate').val();
            const endDateVal = $('#endDate').val();

            if (startDateVal && endDateVal) {
                activeFilters.startDate = new Date(startDateVal);
                activeFilters.startDate.setHours(0, 0, 0, 0);
                activeFilters.endDate = new Date(endDateVal);
                activeFilters.endDate.setHours(23, 59, 59, 999);

                if (activeFilters.startDate.getTime() > activeFilters.endDate.getTime()) {
                    showAlert('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ l·ªõn h∆°n ng√†y k·∫øt th√∫c.', 'danger');
                    activeFilters.startDate = null;
                    activeFilters.endDate = null;
                    return;
                }
                
                $(this).html('<i class="bi bi-check2"></i> ƒê√£ √°p d·ª•ng').addClass('btn-success').removeClass('btn-primary');
                setTimeout(() => {
                    $(this).html('<i class="bi bi-funnel"></i> √Åp d·ª•ng').removeClass('btn-success').addClass('btn-primary');
                }, 2000);
            } else if (startDateVal || endDateVal) {
                showAlert('Vui l√≤ng ch·ªçn c·∫£ "T·ª´ ng√†y" v√† "ƒê·∫øn ng√†y" ƒë·ªÉ l·ªçc theo ng√†y.', 'warning');
                activeFilters.startDate = null;
                activeFilters.endDate = null;
                return;
            } else {
                activeFilters.startDate = null;
                activeFilters.endDate = null;
            }
            applyAllFilters();
        });

        $('#clearDateFilter').on('click', function() {
            $('#startDate').val('');
            $('#endDate').val('');
            activeFilters.startDate = null;
            activeFilters.endDate = null;
            applyAllFilters();
            
            $(this).html('<i class="bi bi-check2"></i> ƒê√£ x√≥a').addClass('btn-success').removeClass('btn-secondary');
            setTimeout(() => {
                $(this).html('<i class="bi bi-x-circle"></i> X√≥a l·ªçc').removeClass('btn-success').addClass('btn-secondary');
            }, 1500);
        });

        // --- Enhanced Toggle Table Section ---
        $('#toggleTableButton').on('click', function() {
            const $tableSection = $('#tableSection');
            const $button = $(this);
            const isHidden = $tableSection.hasClass('hidden');
            
            if (isHidden) {
                $tableSection.removeClass('hidden').hide().fadeIn(300);
                $button.html('<i class="bi bi-table"></i> ·∫®n B·∫£ng');
            } else {
                $tableSection.fadeOut(300, function() {
                    $(this).addClass('hidden');
                });
                $button.html('<i class="bi bi-eye"></i> Hi·ªán B·∫£ng');
            }
        });

        // --- Enhanced Refresh Data Button ---
        $('#refreshDataButton').on('click', function() {
            const $button = $(this);
            $button.prop('disabled', true).html('<i class="bi bi-arrow-clockwise"></i> ƒêang t·∫£i...');
            
            fetchData(true).finally(() => {
                $button.prop('disabled', false).html('<i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi');
            });
        });

        // --- Enhanced Excel Export ---
        $('#exportExcelButton').on('click', function() {
            const $button = $(this);
            $button.prop('disabled', true).html('<i class="bi bi-file-earmark-excel-fill"></i> ƒêang xu·∫•t...');
            
            showLoading('ƒêang chu·∫©n b·ªã xu·∫•t Excel...', true);
            updateProgress(10);
            
            try {
                if (currentData.length === 0) {
                    showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.', 'info');
                    hideLoading();
                    $button.prop('disabled', false).html('<i class="bi bi-file-earmark-excel-fill"></i> Xu·∫•t Excel');
                    return;
                }

                updateProgress(20);
                const wb = XLSX.utils.book_new();
                const visibleColumns = columnOrder.filter(col => columnVisibility[col]);
                const headerNames = visibleColumns.map(col => getColumnDisplayName(col));

                updateProgress(30);
                
                // Group data by month
                const dataByMonth = currentData.reduce((acc, row) => {
                    if (row.ngay_nhan) {
                        try {
                            const date = new Date(row.ngay_nhan);
                            if (!isNaN(date.getTime())) {
                                const monthYear = `${date.getMonth() + 1}-${date.getFullYear()}`;
                                if (!acc[monthYear]) {
                                    acc[monthYear] = [];
                                }
                                acc[monthYear].push(row);
                            }
                        } catch (e) {
                            console.warn('Could not parse date for grouping:', row.ngay_nhan);
                        }
                    }
                    return acc;
                }, {});

                updateProgress(50);
                
                // Create a sheet for each month
                const monthKeys = Object.keys(dataByMonth).sort((a, b) => {
                    const [aMonth, aYear] = a.split('-').map(Number);
                    const [bMonth, bYear] = b.split('-').map(Number);
                    if (aYear !== bYear) return aYear - bYear;
                    return aMonth - bMonth;
                });
                
                monthKeys.forEach(monthKey => {
                    const monthData = dataByMonth[monthKey];
                    const exportData = monthData.map(row => {
                        const obj = {};
                        visibleColumns.forEach(col => {
                            let cellValue = row[col] !== undefined && row[col] !== null ? row[col] : '';
                            if ((col === 'ngay_nhan' || col === 'thoi_han') && cellValue) {
                                try {
                                    const date = new Date(cellValue);
                                    if (!isNaN(date.getTime())) {
                                        cellValue = date.toLocaleDateString('vi-VN');
                                    }
                                } catch (e) {}
                            }
                            if (col === 'sl_nhan' || col === 'sll') {
                                const numValue = parseFloat(cellValue);
                                if (!isNaN(numValue)) {
                                    cellValue = numValue;
                                }
                            }
                            obj[getColumnDisplayName(col)] = cellValue;
                        });
                        return obj;
                    });
                    
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const sheetName = `Thang ${monthKey}`;
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                updateProgress(80);

                // Create summary sheet
                createSummarySheet(wb, currentData);
                
                updateProgress(90);

                // Generate filename with timestamp
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `So_Giao_Nhan_Export_${timestamp}.xlsx`;

                updateProgress(95);
                XLSX.writeFile(wb, filename);
                updateProgress(100);
                
                showAlert(`Xu·∫•t Excel th√†nh c√¥ng! File: ${filename}`, 'success');
            } catch (error) {
                console.error('Excel export error:', error);
                showAlert(`L·ªói khi xu·∫•t Excel: ${error.message}`, 'danger');
            } finally {
                hideLoading();
                $button.prop('disabled', false).html('<i class="bi bi-file-earmark-excel-fill"></i> Xu·∫•t Excel');
            }
        });

        function createSummarySheet(wb, exportData) {
            // Group data by month
            const summaryByMonth = {};
            
            exportData.forEach(row => {
                const ngayNhanStr = row['ngay_nhan'];
                if (ngayNhanStr) {
                    try {
                        const date = new Date(ngayNhanStr);
                        if (!isNaN(date.getTime())) {
                            const month = date.getMonth() + 1;
                            const year = date.getFullYear();
                            const summaryKey = `${month}/${year}`;
                            const slNhan = parseFloat(row['sl_nhan']) || 0;
                            
                            if (!summaryByMonth[summaryKey]) {
                                summaryByMonth[summaryKey] = { totalSlNhan: 0, orderCount: 0 };
                            }
                            summaryByMonth[summaryKey].totalSlNhan += slNhan;
                            summaryByMonth[summaryKey].orderCount++;
                        }
                    } catch (e) {
                        console.warn('Could not parse date for summary:', ngayNhanStr);
                    }
                }
            });

            if (Object.keys(summaryByMonth).length > 0) {
                const summaryData = Object.entries(summaryByMonth)
                    .map(([month, totals]) => ({
                        "Th√°ng": month,
                        "T·ªïng SL Nh·∫≠n": totals.totalSlNhan,
                        "S·ªë ƒë∆°n": totals.orderCount
                    }))
                    .sort((a, b) => {
                        const [aMonth, aYear] = a["Th√°ng"].split('/').map(Number);
                        const [bMonth, bYear] = b["Th√°ng"].split('/').map(Number);
                        if (aYear !== bYear) return aYear - bYear;
                        return aMonth - bMonth;
                    });

                const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                summaryWs['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, summaryWs, "Tong hop");
            }
        }

        // --- Enhanced Clock and Date ---
        let clockInterval;
        function updateClock() {
            const now = new Date();
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false 
            };
            $('#currentDate').text(now.toLocaleDateString('vi-VN', dateOptions));
            $('#currentTime').text(now.toLocaleTimeString('vi-VN', timeOptions));
        }

        function startClock() {
            updateClock();
            clockInterval = setInterval(updateClock, 1000);
        }

        // --- Performance monitoring ---
        function logPerformance(operation, startTime) {
            const endTime = performance.now();
            const duration = Math.round(endTime - startTime);
            console.log(`${operation} completed in ${duration}ms`);
            
            if (duration > 1000) {
                console.warn(`${operation} took longer than expected: ${duration}ms`);
            }
        }

        // --- Keyboard shortcuts ---
        $(document).on('keydown', function(e) {
            // Ctrl+F to focus search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                $('#searchInput').focus();
            }
            
            // Ctrl+R to refresh
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                $('#refreshDataButton').click();
            }
            
            // Ctrl+E to export
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                $('#exportExcelButton').click();
            }
        });

        // --- Initial Load ---
        $(document).ready(function() {
            console.log('Application initialized with enhanced features');
            const startTime = performance.now();
            
            // Initialize UI
            startClock();
            
            // Load data
            fetchData().then(() => {
                logPerformance('Initial data load', startTime);
            }).catch(error => {
                console.error('Initial load failed:', error);
                showAlert('L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng: ' + error.message, 'danger');
            });
            
            // Add tooltips
            $('[title]').tooltip();
        });

        // --- Enhanced Error Handling ---
        window.addEventListener('error', function(event) {
            console.error('Unhandled error:', event.error);
            showAlert('ƒê√£ x·∫£y ra l·ªói kh√¥ng mong mu·ªën. Vui l√≤ng l√†m m·ªõi trang.', 'danger');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showAlert('ƒê√£ x·∫£y ra l·ªói kh√¥ng mong mu·ªën. Vui l√≤ng l√†m m·ªõi trang.', 'danger');
        });

        // --- Auto-save settings ---
        window.addEventListener('beforeunload', function() {
            saveSettings();
        });

        // --- Cleanup on page unload ---
        window.addEventListener('unload', function() {
            if (searchWorker) {
                searchWorker.terminate();
            }
            if (clockInterval) {
                clearInterval(clockInterval);
            }
        });
    </script>
</body>
</html>
