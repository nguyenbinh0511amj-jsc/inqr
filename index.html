<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sổ Giao Nhận</title>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://code.jquery.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" as="style">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin-top: 20px;
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .table-responsive {
            margin-top: 20px;
        }
        th.ui-sortable-handle {
            cursor: grab;
        }
        #columnSelection {
            margin-bottom: 15px;
        }
        #messageArea {
            margin-top: 15px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }
        .loading-overlay p {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        .pagination {
            margin-top: 20px;
        }
        .page-size-selection {
            max-width: 150px;
        }
        .table-section {
            display: block;
        }
        .hidden {
            display: none;
        }
        .progress-bar-container {
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="mainApp" class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-0">Quản lý Sổ Giao Nhận</h1>
                <p class="mb-0">Chào mừng, <span id="loggedInUserName" class="fw-bold">Khách</span>!</p>
            </div>
            <div>
                <p class="mb-0">Ngày: <span id="currentDate"></span></p>
                <p class="mb-0">Giờ: <span id="currentTime"></span></p>
            </div>
        </div>

        <div id="messageArea" class="alert d-none" role="alert"></div>

        <div class="mb-3 d-flex gap-3">
            <div class="flex-grow-1">
                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo Order KD, Tên chi tiết, Code, Họ và tên...">
            </div>
            <div class="page-size-selection">
                <label for="pageSizeSelect" class="form-label">Số dòng mỗi trang:</label>
                <select id="pageSizeSelect" class="form-select">
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                </select>
            </div>
        </div>

        <div class="mb-3 d-flex gap-3 align-items-end">
            <div>
                <label for="startDate" class="form-label">Từ ngày:</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div>
                <label for="endDate" class="form-label">Đến ngày:</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <button class="btn btn-primary" id="applyDateFilter">Áp dụng bộ lọc ngày</button>
            <button class="btn btn-secondary" id="clearDateFilter">Xóa bộ lọc ngày</button>
        </div>
        <div id="columnSelection">
            <label class="form-label">Hiển thị cột:</label>
            <div id="columnCheckboxes" class="d-flex flex-wrap gap-3">
            </div>
        </div>

        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-info me-2" id="exportExcelButton">
                <i class="bi bi-file-earmark-excel"></i> Xuất Excel
            </button>
            <button class="btn btn-warning me-2" id="refreshDataButton">
                <i class="bi bi-arrow-clockwise"></i> Làm mới dữ liệu
            </button>
            <button id="toggleTableButton" class="btn btn-secondary">Ẩn Bảng</button>
        </div>

        <div id="tableSection" class="table-section">
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="dataTable">
                    <thead>
                        <tr id="tableHeaders">
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>

            <nav class="pagination">
                <ul class="pagination justify-content-center">
                    <li class="page-item"><a class="page-link" href="#" id="prevPage">Trước</a></li>
                    <li class="page-item"><span class="page-link" id="pageInfo"></span></li>
                    <li class="page-item"><a class="page-link" href="#" id="nextPage">Sau</a></li>
                </ul>
            </nav>
        </div>

    </div>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="text-center">
            <p id="loadingMessage">Đang tải...</p>
            <div class="progress progress-bar-container" style="width: 300px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script>
        // CONFIGURATION
        const CONFIG = {
            appId: 'e1339939-5987-4d7a-8c73-436348abf6b7',
            accessKey: 'V2-WTcys-x7QFl-Z5SzF-zSe7D-qciuV-yaUHk-CDGEe-oSexL',
            tableName: 'so_giao_nhan',
            maxRetries: 3,
            retryDelay: 1000,
            pageSizeOptions: [50, 100, 200, 500],
            defaultPageSize: 50,
            cacheDuration: 5 * 60 * 1000,
            requestTimeout: 30000 // 30 seconds timeout
        };

        const BASE_URL = `https://api.appsheet.com/api/v2/apps/${CONFIG.appId}/tables/`;
        const CACHE_KEY = 'so_giao_nhan_data_cache';

        let originalData = [];
        let currentData = [];
        let columnOrder = ['order_kd', 'ten_chi_tiet', 'so_file', 'sll', 'tinh_chat', 'ghi_chu', 'noi_gia_cong', 'thoi_han', 'ngay_nhan', 'gio_nhan', 'tap_tho', 'sl_nhan', 'code', 'ho_va_ten'];
        let columnVisibility = {
            'order_kd': true,
            'ten_chi_tiet': true,
            'so_file': true,
            'sll': true,
            'tinh_chat': true,
            'ghi_chu': true,
            'noi_gia_cong': true,
            'thoi_han': true,
            'ngay_nhan': true,
            'gio_nhan': true,
            'tap_tho': true,
            'sl_nhan': true,
            'code': false,
            'ho_va_ten': true
        };
        let currentPage = 1;
        let pageSize = parseInt(localStorage.getItem('pageSize')) || CONFIG.defaultPageSize;
        let activeFilters = {
            searchTerm: '',
            startDate: null,
            endDate: null
        };

        // --- Utility Functions ---
        function showLoading(message = 'Đang tải...', showProgress = false) {
            $('#loadingMessage').text(message);
            if (showProgress) {
                $('.progress-bar-container').show();
                $('#progressBar').css('width', '0%');
            } else {
                $('.progress-bar-container').hide();
            }
            $('#loadingOverlay').removeClass('d-none');
        }

        function updateProgress(percent) {
            $('#progressBar').css('width', percent + '%');
        }

        function hideLoading() {
            $('#loadingOverlay').addClass('d-none');
            $('.progress-bar-container').hide();
        }

        function showAlert(message, type = 'danger', target = '#messageArea') {
            const alertDiv = $(target);
            alertDiv.text(message).removeClass('d-none alert-success alert-danger alert-info alert-warning').addClass(`alert-${type}`);
            if (target === '#messageArea') {
                setTimeout(() => alertDiv.addClass('d-none'), 5000);
            }
        }

        function clearAlert(target = '#messageArea') {
            $(target).addClass('d-none').text('');
        }

        // Improved error handling with timeout
        async function makeAppSheetRequest(url, method, data, retries = 0) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.requestTimeout);

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': CONFIG.accessKey
                    },
                    body: data ? JSON.stringify(data) : null,
                    signal: controller.signal
                };

                console.log(`Sending request to ${url}:`, options);

                const response = await fetch(url, options);
                clearTimeout(timeoutId);

                let responseData;
                try {
                    responseData = await response.json();
                } catch (jsonError) {
                    const rawText = await response.text();
                    console.error('Lỗi phân tích JSON:', jsonError);
                    console.error('Phản hồi API thô:', rawText);
                    throw new Error(`Định dạng phản hồi API không hợp lệ. Raw: "${rawText.substring(0, 100)}..."`);
                }

                console.log('API response:', responseData);

                if (!response.ok) {
                    if (retries < CONFIG.maxRetries && response.status >= 500) {
                        console.warn(`Yêu cầu thất bại. Thử lại... (${retries + 1}/${CONFIG.maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, CONFIG.retryDelay * (retries + 1)));
                        return makeAppSheetRequest(url, method, data, retries + 1);
                    }
                    
                    let errorMessage = 'Lỗi không xác định khi giao tiếp với AppSheet.';
                    if (response.status === 401) {
                        errorMessage = 'Lỗi xác thực: Khóa truy cập không hợp lệ hoặc thiếu quyền.';
                    } else if (response.status === 404) {
                        errorMessage = `Không tìm thấy bảng "${CONFIG.tableName}". Vui lòng kiểm tra App ID và tên bảng.`;
                    } else if (response.status === 429) {
                        errorMessage = 'Quá nhiều yêu cầu. Vui lòng thử lại sau ít phút.';
                    } else if (responseData && responseData.Message) {
                        errorMessage = responseData.Message;
                    }
                    throw new Error(errorMessage);
                }
                return responseData;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Yêu cầu quá thời gian chờ. Vui lòng thử lại.');
                }
                throw error;
            }
        }

        // --- Data Fetching with improved performance ---
        async function fetchData(forceRefresh = false) {
            showLoading('Đang kiểm tra dữ liệu...', true);
            clearAlert();
            updateProgress(10);

            if (!forceRefresh) {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    try {
                        const { timestamp, data } = JSON.parse(cached);
                        const now = new Date().getTime();

                        if (now - timestamp < CONFIG.cacheDuration && Array.isArray(data) && data.length > 0) {
                            updateProgress(50);
                            originalData = data;
                            applyAllFilters();
                            currentPage = 1;
                            initializeColumns();
                            updateProgress(90);
                            renderTableWithPagination(currentData);
                            updateProgress(100);
                            showAlert(`Dữ liệu được tải từ bộ nhớ đệm (${data.length} bản ghi).`, 'info');
                            console.log('Data loaded from cache. Triggering background refresh.');
                            setTimeout(() => fetchFreshData(false), 1000);
                            return;
                        } else {
                            console.log('Cached data expired or invalid. Fetching fresh data.');
                            localStorage.removeItem(CACHE_KEY);
                        }
                    } catch (e) {
                        console.error('Lỗi phân tích dữ liệu bộ nhớ đệm:', e);
                        localStorage.removeItem(CACHE_KEY);
                    }
                }
            }

            await fetchFreshData(true);
        }

        async function fetchFreshData(showUI = true) {
            if (showUI) {
                showLoading('Đang tải dữ liệu mới nhất...', true);
                updateProgress(20);
            } else {
                console.log('Background data refresh started.');
            }
            
            try {
                const actionRequestBody = {
                    "Action": "Find",
                    "Properties": {
                        "Locale": "en-US",
                        "Location": "47.620921, -122.347276",
                        "Timezone": "Pacific Standard Time"
                    }
                };

                if (showUI) updateProgress(40);
                
                console.log('Fetching data from AppSheet:', actionRequestBody);
                const data = await makeAppSheetRequest(`${BASE_URL}${CONFIG.tableName}/Action`, 'POST', actionRequestBody);

                if (showUI) updateProgress(70);

                if (data && Array.isArray(data)) {
                    if (data.length > 0) {
                        originalData = data;
                        
                        // Save to cache
                        try {
                            localStorage.setItem(CACHE_KEY, JSON.stringify({ 
                                timestamp: new Date().getTime(), 
                                data: data 
                            }));
                        } catch (storageError) {
                            console.warn('Could not save to localStorage:', storageError);
                        }

                        if (showUI) updateProgress(80);
                        applyAllFilters();
                        currentPage = 1;
                        initializeColumns();
                        if (showUI) updateProgress(95);
                        renderTableWithPagination(currentData);
                        if (showUI) updateProgress(100);
                        
                        if (showUI) {
                            showAlert(`Tải dữ liệu thành công! (${data.length} bản ghi)`, 'success');
                        } else {
                            console.log(`Background data refresh successful. ${data.length} records loaded.`);
                        }
                    } else {
                        originalData = [];
                        currentData = [];
                        renderTableWithPagination([]);
                        initializeColumns();
                        if (showUI) {
                            showAlert('Bảng hoặc Slice không có dữ liệu.', 'info');
                        }
                        localStorage.removeItem(CACHE_KEY);
                    }
                } else {
                    throw new Error('Phản hồi API không phải là mảng dữ liệu.');
                }
            } catch (error) {
                console.error('Lỗi tải dữ liệu:', error);
                let errorMessage = `Lỗi khi tải dữ liệu: ${error.message}`;
                
                if (showUI) {
                    showAlert(errorMessage, 'danger');
                }
                localStorage.removeItem(CACHE_KEY);
                originalData = [];
                currentData = [];
                renderTableWithPagination([]);
            } finally {
                if (showUI) {
                    hideLoading();
                }
            }
        }

        // --- Column Management ---
        function initializeColumns() {
            $('#pageSizeSelect').val(pageSize);
            renderColumnCheckboxes();
            renderTableHeaders();
        }

        function renderColumnCheckboxes() {
            const $checkboxes = $('#columnCheckboxes');
            $checkboxes.empty();
            columnOrder.forEach(col => {
                const displayName = getColumnDisplayName(col);
                const isChecked = columnVisibility[col] ? 'checked' : '';
                $checkboxes.append(`
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle_${col}" data-column="${col}" ${isChecked}>
                        <label class="form-check-label" for="toggle_${col}">${displayName}</label>
                    </div>
                `);
            });

            $('.column-toggle').off('change').on('change', function() {
                const column = $(this).data('column');
                columnVisibility[column] = $(this).is(':checked');
                renderTableHeaders();
                renderTableWithPagination(currentData);
            });
        }

        function renderTableHeaders() {
            const $headers = $('#tableHeaders');
            $headers.empty();
            const visibleColumns = columnOrder.filter(col => columnVisibility[col]);
            visibleColumns.forEach(col => {
                const displayName = getColumnDisplayName(col);
                $headers.append(`<th data-column="${col}">${displayName}</th>`);
            });

            $headers.sortable({
                items: 'th',
                axis: 'x',
                update: function(event, ui) {
                    const newOrder = [];
                    $('#tableHeaders th').each(function() {
                        newOrder.push($(this).data('column'));
                    });
                    columnOrder = newOrder;
                    renderColumnCheckboxes();
                    renderTableWithPagination(currentData);
                }
            });
            $headers.disableSelection();
        }

        function getColumnDisplayName(columnName) {
            const displayNames = {
                'order_kd': 'Order KD',
                'ten_chi_tiet': 'Tên chi tiết',
                'so_file': 'Số file',
                'sll': 'SLL',
                'tinh_chat': 'Tính chất',
                'ghi_chu': 'Ghi chú',
                'noi_gia_cong': 'Nơi gia công',
                'thoi_han': 'Thời hạn',
                'ngay_nhan': 'Ngày nhận',
                'gio_nhan': 'Giờ nhận',
                'tap_tho': 'Tap thô',
                'sl_nhan': 'SL nhận',
                'code': 'Code',
                'ho_va_ten': 'Họ và tên'
            };
            return displayNames[columnName] || columnName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        // --- Optimized Table Rendering ---
        function renderTableWithPagination(data) {
            const $tbody = $('#tableBody');
            $tbody.empty();

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedData = data.slice(start, end);
            const visibleColumns = columnOrder.filter(col => columnVisibility[col]);

            if (paginatedData.length === 0) {
                $tbody.append(`<tr><td colspan="${visibleColumns.length}" class="text-center">Không tìm thấy dữ liệu phù hợp.</td></tr>`);
            } else {
                const fragment = document.createDocumentFragment();
                paginatedData.forEach(row => {
                    const tr = document.createElement('tr');
                    visibleColumns.forEach(col => {
                        const td = document.createElement('td');
                        let cellValue = row[col] !== undefined && row[col] !== null ? row[col] : '';
                        
                        // Optimize date formatting
                        if ((col === 'ngay_nhan' || col === 'thoi_han') && cellValue) {
                            try {
                                const date = new Date(cellValue);
                                if (!isNaN(date.getTime())) {
                                    cellValue = date.toLocaleDateString('vi-VN');
                                }
                            } catch (e) {
                                // Keep original value if date parsing fails
                            }
                        }
                        
                        td.textContent = String(cellValue);
                        tr.appendChild(td);
                    });
                    fragment.appendChild(tr);
                });
                $tbody[0].appendChild(fragment);
            }

            // Update pagination controls
            const totalPages = Math.ceil(data.length / pageSize);
            $('#pageInfo').text(`Trang ${currentPage} / ${totalPages} (${data.length} bản ghi)`);
            $('#prevPage').parent().toggleClass('disabled', currentPage === 1);
            $('#nextPage').parent().toggleClass('disabled', currentPage === totalPages);
        }

        // --- Pagination Controls ---
        $('#prevPage').on('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                renderTableWithPagination(currentData);
            }
        });

        $('#nextPage').on('click', function(e) {
            e.preventDefault();
            if (currentPage < Math.ceil(currentData.length / pageSize)) {
                currentPage++;
                renderTableWithPagination(currentData);
            }
        });

        $('#pageSizeSelect').on('change', function() {
            pageSize = parseInt($(this).val());
            localStorage.setItem('pageSize', pageSize);
            currentPage = 1;
            renderTableWithPagination(currentData);
        });

        // --- Optimized Search and Filter ---
        function applyAllFilters() {
            let filteredData = [...originalData]; // Create a copy to avoid mutations

            // Apply search term filter
            if (activeFilters.searchTerm) {
                const searchTermLower = activeFilters.searchTerm.toLowerCase();
                filteredData = filteredData.filter(row => {
                    const orderKd = row['order_kd'] ? String(row['order_kd']).toLowerCase() : '';
                    const tenChiTiet = row.ten_chi_tiet ? String(row.ten_chi_tiet).toLowerCase() : '';
                    const code = row.code ? String(row.code).toLowerCase() : '';
                    const hoVaTen = row.ho_va_ten ? String(row.ho_va_ten).toLowerCase() : '';
                    
                    return orderKd.includes(searchTermLower) ||
                           tenChiTiet.includes(searchTermLower) ||
                           code.includes(searchTermLower) ||
                           hoVaTen.includes(searchTermLower);
                });
            }

            // Apply date range filter
            if (activeFilters.startDate && activeFilters.endDate) {
                filteredData = filteredData.filter(row => {
                    if (row.ngay_nhan) {
                        try {
                            const ngayNhanDate = new Date(row.ngay_nhan);
                            if (!isNaN(ngayNhanDate.getTime())) {
                                ngayNhanDate.setHours(0, 0, 0, 0);
                                return ngayNhanDate >= activeFilters.startDate && ngayNhanDate <= activeFilters.endDate;
                            }
                        } catch (e) {
                            console.warn('Invalid date format:', row.ngay_nhan);
                        }
                    }
                    return false;
                });
            }

            currentData = filteredData;
            currentPage = 1;
            renderTableWithPagination(currentData);
        }

        // Debounced search
        let searchTimeout;
        $('#searchInput').on('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                activeFilters.searchTerm = $(this).val();
                applyAllFilters();
            }, 300);
        });

        $('#applyDateFilter').on('click', function() {
            const startDateVal = $('#startDate').val();
            const endDateVal = $('#endDate').val();

            if (startDateVal && endDateVal) {
                activeFilters.startDate = new Date(startDateVal);
                activeFilters.startDate.setHours(0, 0, 0, 0);
                activeFilters.endDate = new Date(endDateVal);
                activeFilters.endDate.setHours(23, 59, 59, 999);

                if (activeFilters.startDate.getTime() > activeFilters.endDate.getTime()) {
                    showAlert('Ngày bắt đầu không thể lớn hơn ngày kết thúc.', 'danger');
                    activeFilters.startDate = null;
                    activeFilters.endDate = null;
                    return;
                }
            } else if (startDateVal || endDateVal) {
                showAlert('Vui lòng chọn cả "Từ ngày" và "Đến ngày" để lọc theo ngày.', 'warning');
                activeFilters.startDate = null;
                activeFilters.endDate = null;
                return;
            } else {
                activeFilters.startDate = null;
                activeFilters.endDate = null;
            }
            applyAllFilters();
        });

        $('#clearDateFilter').on('click', function() {
            $('#startDate').val('');
            $('#endDate').val('');
            activeFilters.startDate = null;
            activeFilters.endDate = null;
            applyAllFilters();
        });

        // --- Toggle Table Section ---
        $('#toggleTableButton').on('click', function() {
            const $tableSection = $('#tableSection');
            const isHidden = $tableSection.hasClass('hidden');
            if (isHidden) {
                $tableSection.removeClass('hidden');
                $(this).text('Ẩn Bảng');
            } else {
                $tableSection.addClass('hidden');
                $(this).text('Hiện Bảng');
            }
        });

        // --- Refresh Data Button ---
        $('#refreshDataButton').on('click', function() {
            fetchData(true);
        });

        // --- Fixed Excel Export ---
        $('#exportExcelButton').on('click', function() {
            showLoading('Đang chuẩn bị xuất Excel...', true);
            updateProgress(10);
            
            try {
                if (currentData.length === 0) {
                    showAlert('Không có dữ liệu để xuất.', 'info');
                    hideLoading();
                    return;
                }

                updateProgress(20);
                const wb = XLSX.utils.book_new();
                const visibleColumns = columnOrder.filter(col => columnVisibility[col]);

                updateProgress(30);
                
                // Prepare export data with proper formatting
                const exportData = currentData.map(row => {
                    const obj = {};
                    visibleColumns.forEach(col => {
                        let cellValue = row[col] !== undefined && row[col] !== null ? row[col] : '';
                        
                        // Format dates for Excel
                        if ((col === 'ngay_nhan' || col === 'thoi_han') && cellValue) {
                            try {
                                const date = new Date(cellValue);
                                if (!isNaN(date.getTime())) {
                                    cellValue = date.toLocaleDateString('vi-VN');
                                }
                            } catch (e) {
                                // Keep original value if date parsing fails
                            }
                        }
                        
                        // Ensure numeric values are properly formatted
                        if (col === 'sl_nhan' || col === 'sll') {
                            const numValue = parseFloat(cellValue);
                            if (!isNaN(numValue)) {
                                cellValue = numValue;
                            }
                        }
                        
                        obj[getColumnDisplayName(col)] = cellValue;
                    });
                    return obj;
                });

                updateProgress(50);

                // Function to clean sheet name (remove invalid characters)
                function cleanSheetName(name) {
                    // Remove or replace invalid characters: \ / ? * [ ]
                    return name.replace(/[\\\/\?\*\[\]]/g, '-').substring(0, 31); // Excel sheet name max 31 chars
                }

                // Group data by month for multiple sheets
                const dataByMonth = {};
                const summaryByMonth = {};

                exportData.forEach(row => {
                    const ngayNhanStr = row['Ngày nhận'];
                    if (ngayNhanStr) {
                        try {
                            // Parse the Vietnamese date format
                            const dateParts = ngayNhanStr.split('/');
                            if (dateParts.length === 3) {
                                const day = parseInt(dateParts[0]);
                                const month = parseInt(dateParts[1]);
                                const year = parseInt(dateParts[2]);
                                
                                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                                    const monthYearKey = `${year}-${month.toString().padStart(2, '0')}`;
                                    const monthYearDisplay = `Thang ${month}-${year}`; // Use safe characters
                                    
                                    if (!dataByMonth[monthYearKey]) {
                                        dataByMonth[monthYearKey] = {
                                            data: [],
                                            display: monthYearDisplay
                                        };
                                    }
                                    dataByMonth[monthYearKey].data.push(row);
                                    
                                    // Calculate summary
                                    const slNhan = parseFloat(row['SL nhận']) || 0;
                                    const summaryKey = `Tháng ${month}/${year}`;
                                    summaryByMonth[summaryKey] = (summaryByMonth[summaryKey] || 0) + slNhan;
                                }
                            }
                        } catch (e) {
                            console.warn('Could not parse date for grouping:', ngayNhanStr);
                        }
                    }
                });

                updateProgress(60);

                // Sort months chronologically
                const sortedMonthKeys = Object.keys(dataByMonth).sort();

                // Create sheets for each month
                if (sortedMonthKeys.length > 0) {
                    sortedMonthKeys.forEach((monthKey, index) => {
                        const monthInfo = dataByMonth[monthKey];
                        const ws = XLSX.utils.json_to_sheet(monthInfo.data);
                        
                        // Set column widths for better readability
                        const colWidths = visibleColumns.map(col => {
                            const displayName = getColumnDisplayName(col);
                            return { wch: Math.max(displayName.length, 15) };
                        });
                        ws['!cols'] = colWidths;
                        
                        // Clean sheet name to avoid Excel errors
                        const cleanedSheetName = cleanSheetName(monthInfo.display);
                        XLSX.utils.book_append_sheet(wb, ws, cleanedSheetName);
                        
                        if (index === 0) {
                            addExcelFooter(ws);
                        }
                    });
                } else {
                    // If no monthly data, create a single sheet
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const colWidths = visibleColumns.map(col => {
                        const displayName = getColumnDisplayName(col);
                        return { wch: Math.max(displayName.length, 15) };
                    });
                    ws['!cols'] = colWidths;
                    XLSX.utils.book_append_sheet(wb, ws, "Tat ca du lieu");
                    addExcelFooter(ws);
                }

                updateProgress(80);

                // Create summary sheet
                if (Object.keys(summaryByMonth).length > 0) {
                    const summaryData = Object.entries(summaryByMonth)
                        .map(([month, total]) => ({
                            "Tháng": month,
                            "Tổng SL Nhận": total
                        }))
                        .sort((a, b) => {
                            // Sort by year and month
                            const extractYearMonth = (str) => {
                                const match = str.match(/Tháng (\d+)\/(\d+)/);
                                if (match) {
                                    return { year: parseInt(match[2]), month: parseInt(match[1]) };
                                }
                                return { year: 0, month: 0 };
                            };
                            
                            const aDate = extractYearMonth(a["Tháng"]);
                            const bDate = extractYearMonth(b["Tháng"]);
                            
                            if (aDate.year !== bDate.year) {
                                return aDate.year - bDate.year;
                            }
                            return aDate.month - bDate.month;
                        });

                    const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                    summaryWs['!cols'] = [{ wch: 20 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, summaryWs, "Tong hop SL Nhan");
                }

                updateProgress(90);

                // Generate filename with timestamp
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `So_Giao_Nhan_Export_${timestamp}.xlsx`;

                updateProgress(95);
                XLSX.writeFile(wb, filename);
                updateProgress(100);
                
                showAlert(`Xuất Excel thành công! File: ${filename}`, 'success');
            } catch (error) {
                console.error('Excel export error:', error);
                showAlert(`Lỗi khi xuất Excel: ${error.message}`, 'danger');
            } finally {
                hideLoading();
            }
        });

        // Function to add footer to Excel sheet
        function addExcelFooter(ws) {
            try {
                const now = new Date();
                const exportDateTime = now.toLocaleString('vi-VN');
                const exporter = 'Người dùng';

                const footerData = [
                    [''],
                    ['Thông tin xuất:'],
                    ['Ngày xuất:', exportDateTime],
                    ['Người xuất:', exporter],
                    ['Tổng số bản ghi:', currentData.length]
                ];

                // Find the last row with data
                const range = ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']) : { e: { r: 0 } };
                const startRow = range.e.r + 2;

                XLSX.utils.sheet_add_aoa(ws, footerData, { origin: startRow });
                
                // Update the range to include footer
                const newRange = XLSX.utils.encode_range({
                    s: { c: 0, r: 0 },
                    e: { c: Math.max(range.e.c, 1), r: startRow + footerData.length - 1 }
                });
                ws['!ref'] = newRange;
            } catch (error) {
                console.warn('Could not add footer to Excel sheet:', error);
            }
        }

        // --- Clock and Date ---
        let clockInterval;
        function updateClock() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            $('#currentDate').text(now.toLocaleDateString('vi-VN', dateOptions));
            $('#currentTime').text(now.toLocaleTimeString('vi-VN', timeOptions));
        }

        function startClock() {
            updateClock();
            clockInterval = setInterval(updateClock, 1000);
        }

        // --- Performance monitoring ---
        function logPerformance(operation, startTime) {
            const endTime = performance.now();
            const duration = Math.round(endTime - startTime);
            console.log(`${operation} completed in ${duration}ms`);
        }

        // --- Initial Load ---
        $(document).ready(function() {
            console.log('Application initialized');
            const startTime = performance.now();
            
            startClock();
            fetchData().then(() => {
                logPerformance('Initial data load', startTime);
            }).catch(error => {
                console.error('Initial load failed:', error);
                showAlert('Lỗi khởi tạo ứng dụng: ' + error.message, 'danger');
            });
        });

        // --- Error boundary for unhandled errors ---
        window.addEventListener('error', function(event) {
            console.error('Unhandled error:', event.error);
            showAlert('Đã xảy ra lỗi không mong muốn. Vui lòng làm mới trang.', 'danger');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showAlert('Đã xảy ra lỗi không mong muốn. Vui lòng làm mới trang.', 'danger');
        });
    </script>
</body>
</html>
