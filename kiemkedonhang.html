<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm Kê Đơn Hàng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdL5b8719875F07+vL49R462Q519hL31v2R2Ff8e0Q5Fp0B+p0Qv6j+Q/Q0C6G51R7G0F61O+q5Fp0B+p0Qv6j+Q/Q0C6G51R7G0F61O+q5Fp0B+p0Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Thiết lập chung */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif; /* Font hiện đại hơn */
            background-color: #f4f7fa; /* Nền sáng, nhẹ nhàng */
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1800px; /* ĐÃ MỞ RỘNG: Tăng kích thước tối đa của container */
            margin: 0 auto;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); 
            overflow: hidden;
        }

        /* Header */
        .header {
            background-color: #2c3e50; /* Màu tối, sang trọng */
            padding: 30px;
            text-align: center;
            color: white;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.8;
        }

        /* Controls và Filters */
        .controls {
            padding: 25px 30px;
            background-color: #ffffff;
            border-bottom: 1px solid #e5e9ec;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .form-group label i {
            margin-right: 8px;
            color: #3498db;
        }

        .form-group input, .form-group select {
            padding: 10px 15px;
            border: 1px solid #dcdfe4;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f7f9fb;
            color: #2c3e50;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            background: white;
        }

        .search-container {
            position: relative;
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px 12px 50px; /* Thêm padding bên trái cho icon */
            border: 1px solid #dcdfe4;
            border-radius: 50px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f7f9fb;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 20px; /* Di chuyển icon sang trái */
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
            font-size: 1rem;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 50px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #3498db; /* Xanh dương */
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background-color: #2ecc71; /* Xanh lá */
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-warning {
            background-color: #f39c12; /* Vàng cam */
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(243, 156, 18, 0.3);
        }

        /* Content và Status */
        .content {
            padding: 30px;
        }

        .status {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
            border-left: 5px solid; /* Điểm nhấn trạng thái */
        }

        .status.loading {
            background-color: #ecf0f1;
            color: #34495e;
            border-color: #95a5a6;
            display: flex;
            align-items: center;
        }

        .status.success {
            background-color: #e8f9f2;
            color: #27ae60;
            border-color: #2ecc71;
            display: block;
        }

        .status.error {
            background-color: #fde8e8;
            color: #c0392b;
            border-color: #e74c3c;
            display: block;
            max-height: 450px;
            overflow-y: auto;
        }

        .status.error h3 {
            margin-bottom: 10px;
            color: #e74c3c;
            font-size: 1.2rem;
        }
        
        /* Cải tiến hiển thị lỗi */
        .status.error ol, .status.error ul {
            margin: 10px 0 10px 20px;
            padding-left: 0;
            list-style-type: disc;
        }

        .status.error li {
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 0.95rem;
        }
        
        .status.error a {
            color: #2980b9;
            text-decoration: none;
        }
        
        .status.error a:hover {
            text-decoration: underline;
        }
        
        .status.error code {
            background-color: #f7f9fb;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #e74c3c;
        }


        /* Thống kê */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #ffffff;
            color: #2c3e50;
            padding: 25px;
            border-radius: 12px;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #3498db; /* Điểm nhấn màu xanh */
            transition: all 0.3s ease;
        }

        /* THAY ĐỔI CSS Ở ĐÂY: Thêm 1 thẻ stat-card nữa */
        .stat-card:nth-child(2) { border-left-color: #2ecc71; } /* Xanh lá */
        .stat-card:nth-child(3) { border-left-color: #f39c12; } /* Vàng cam (Cho Tổng SLL) */
        .stat-card:nth-child(4) { border-left-color: #e74c3c; } /* Đỏ (Cho Vị trí khác nhau) */


        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #3498db; /* Màu nổi bật */
        }
        
        .stat-card:nth-child(2) .stat-number { color: #2ecc71; }
        .stat-card:nth-child(3) .stat-number { color: #f39c12; } /* Màu cho Tổng SLL */
        .stat-card:nth-child(4) .stat-number { color: #e74c3c; } /* Màu cho Vị trí khác nhau */


        .stat-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Bảng Dữ liệu */
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e9ec;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th {
            background-color: #34495e; /* Màu nền header tối */
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 3px solid #3498db;
            white-space: nowrap;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9rem;
            vertical-align: middle;
            color: #34495e;
        }

        .data-table tr:hover {
            background-color: #fcfdfe; /* Hiệu ứng hover nhẹ */
        }

        .highlight {
            background-color: #fcf3cf; /* Màu vàng nhạt */
            color: #8b600a;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* CSS BỔ SUNG CHO CỘT TRẠNG THÁI */
        .status-cell {
            text-align: center;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .da-kiem-ke {
            background-color: #e8f9f2; /* Màu nền xanh lá nhạt */
            color: #27ae60; /* Màu chữ xanh lá đậm */
        }
        /* KẾT THÚC CSS BỔ SUNG */


        /* Responsive */
        @media (max-width: 992px) {
            .filter-group {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
            .stats {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Điều chỉnh lại grid cho stats */
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .controls, .content {
                padding: 15px;
            }
            .button-group {
                justify-content: center;
            }
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            .data-table th, .data-table td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-warehouse"></i>Kiểm Kê Đơn Hàng</h1>
            <p>Quản lý, tìm kiếm và xuất dữ liệu kiểm kê từ AppSheet</p>
        </div>

        <div class="controls">
            <div class="filter-group">
                <div class="form-group">
                    <label for="fromDate"><i class="fas fa-calendar-alt"></i> Từ ngày:</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="form-group">
                    <label for="toDate"><i class="fas fa-calendar-alt"></i> Đến ngày:</label>
                    <input type="date" id="toDate">
                </div>
                <div class="form-group">
                    <label for="positionFilter"><i class="fas fa-map-marker-alt"></i> Vị trí:</label>
                    <select id="positionFilter">
                        <option value="">-- Tất cả vị trí --</option>
                    </select>
                </div>
            </div>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Tìm kiếm Order KD, Tên chi tiết, QR code...">
                <span class="search-icon"><i class="fas fa-search"></i></span>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="loadData()">
                    <span id="loadText"><i class="fas fa-download"></i> Tải dữ liệu</span>
                </button>
                <button class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Xuất Excel
                </button>
                <button class="btn btn-warning" onclick="clearFilters()">
                    <i class="fas fa-sync-alt"></i> Xóa bộ lọc
                </button>
            </div>
        </div>

        <div class="content">
            <div id="status" class="status"></div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-label">Tổng số đơn hàng</div>
                    <div class="stat-number" id="totalRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tổng số đơn hàng theo khu vực</div>
                    <div class="stat-number" id="filteredRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tổng số lượng</div>
                    <div class="stat-number" id="totalSLL">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Khu vực kiểm kê</div>
                    <div class="stat-number" id="uniquePositions">0</div>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table" id="dataTable" style="display: none;">
                    <thead>
                        <tr>
                            <th><i class="fas fa-clipboard-list"></i> Order KD</th>
                            <th><i class="fas fa-tag"></i> Tên chi tiết</th>
                            <th><i class="fas fa-file-alt"></i> Số file</th>
                            <th><i class="fas fa-sort-numeric-up"></i> SLL</th>
                            <th><i class="fas fa-qrcode"></i> QR code</th>
                            <th><i class="fas fa-map-pin"></i> Vị trí</th>
                            <th><i class="fas fa-check-double"></i> SL kiểm đếm</th>
                            <th><i class="fas fa-box-open"></i> Từ thùng</th>
                            <th><i class="fas fa-box"></i> Đến thùng</th>
                            <th><i class="fas fa-qrcode"></i> Check QR</th>
                            <th><i class="fas fa-comment-dots"></i> Ghi chú</th>
                            <th><i class="fas fa-code"></i> Code</th>
                            <th><i class="fas fa-user-circle"></i> Họ và tên</th>
                            <th><i class="fas fa-calendar-check"></i> Ngày nhập</th>
                            <th><i class="fas fa-hourglass-half"></i> Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- CẦN THAY THẾ SHEET_ID và API_KEY CỦA BẠN VÀO ĐÂY ---
        const SHEET_ID = '1uWHw7ME46tF5bkB0vrUM-Ubi982k4l3sHuqYcy3dFF4'; // Thay bằng Sheet ID thực tế
        const API_KEY = 'AIzaSyCrC_DfD_DrpjzjO5ENvqTMHBA4FIDBiP0'; // Thay bằng API Key thực tế
        const RANGE = 'Nhập đơn hàng kiểm kê!A:O'; 
        
        let allData = [];
        let filteredData = [];

        // Thiết lập ngày mặc định
        function setDefaultDates() {
            const today = new Date();
            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('fromDate').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('toDate').value = today.toISOString().split('T')[0];
        }

        // Hiển thị trạng thái
        function showStatus(message, type) {
            const status = document.getElementById('status');
            // Thêm spinner cho trạng thái loading
            if (type === 'loading') {
                status.innerHTML = `<span class="loading-spinner"></span> ${message}`;
            } else {
                status.textContent = message;
            }
            status.className = `status ${type}`;
        }

        // Tải dữ liệu từ AppSheet API
        async function loadData() {
            const loadButton = document.querySelector('.btn-primary');
            const loadText = document.getElementById('loadText');
            
            loadButton.disabled = true;
            loadText.innerHTML = '<span class="loading-spinner"></span> Đang tải...';
            showStatus('Đang kết nối AppSheet API...', 'loading');

            try {
                // Chỉ sử dụng AppSheet API
                const data = await fetchGoogleSheetsData();
                
                if (!data || !data.values || data.values.length === 0) {
                    throw new Error('Không có dữ liệu trong bảng tính hoặc không thể truy cập');
                }

                // Kiểm tra header
                const headers = data.values[0];
                console.log('Headers từ AppSheet:', headers);

                // Bỏ qua hàng đầu tiên (header) và xử lý dữ liệu
                const rows = data.values.slice(1);
                
                allData = rows.map((row, index) => {
                    // Đảm bảo mỗi row có đủ 15 cột
                    while (row.length < 15) {
                        row.push('');
                    }
                    
                    return {
                        orderKD: row[0] || '',
                        tenChiTiet: row[1] || '',
                        soFile: row[2] || '',
                        sll: row[3] || '',
                        qrCode: row[4] || '',
                        viTri: row[5] || '',
                        slKiemDem: row[6] || '',
                        tuThung: row[7] || '',
                        denThung: row[8] || '',
                        checkQR: row[9] || '',
                        ghiChu: row[10] || '',
                        code: row[11] || '',
                        hoVaTen: row[12] || '',
                        ngayNhap: row[13] || '',
                        trangThai: row[14] || ''
                    };
                });

                // Loại bỏ các dòng trống
                allData = allData.filter(row => 
                    Object.values(row).some(value => value && value.trim() !== '')
                );

                populatePositionFilter();
                applyFilters();
                showStatus(`✅ Đã tải thành công ${allData.length} bản ghi từ AppSheet!`, 'success');
                
                // Hiển thị bảng và thống kê
                document.getElementById('dataTable').style.display = 'table';
                document.getElementById('stats').style.display = 'grid';
                
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                showGoogleSheetsError(error);
            } finally {
                loadButton.disabled = false;
                loadText.innerHTML = '<i class="fas fa-download"></i> Tải dữ liệu';
            }
        }

        // Fetch dữ liệu từ AppSheet API
        async function fetchGoogleSheetsData() {
            // SỬ DỤNG V4 API
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            
            console.log('Đang gọi API:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorBody = await response.text();
                console.log('Error response body:', errorBody);
                
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorJson = JSON.parse(errorBody);
                    if (errorJson.error && errorJson.error.message) {
                        errorMessage += `: ${errorJson.error.message}`;
                    }
                } catch (e) {
                    errorMessage += `: ${errorBody}`;
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            console.log('Dữ liệu nhận được:', {
                totalRows: data.values ? data.values.length : 0,
                firstRow: data.values ? data.values[0] : null
            });

            return data;
        }

        // Hiển thị lỗi AppSheet với hướng dẫn chi tiết
        function showGoogleSheetsError(error) {
            const status = document.getElementById('status');
            
            let errorHTML = `
                <div style="text-align: left;">
                    <h3><i class="fas fa-exclamation-triangle"></i> Lỗi Kết Nối Google Sheets API</h3>
                    <p><strong>Lỗi:</strong> ${error.message}</p>
                    <br>
            `;

            if (error.message.includes('403') || error.message.includes('API key not valid')) {
                errorHTML += `
                    <h4><i class="fas fa-tools"></i> Khắc phục lỗi 403 (Forbidden) hoặc API Key:</h4>
                    <ol>
                        <li><strong>Kiểm tra API Key:</strong>
                            <ul>
                                <li>Truy cập <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></li>
                                <li>Đảm bảo API key: <code>${API_KEY.substring(0, 10)}...</code> còn hiệu lực</li>
                                <li>Kiểm tra quota và usage limits</li>
                            </ul>
                        </li>
                        <li><strong>Bật Sheets API:</strong>
                            <ul>
                                <li>Trong Google Cloud Console, tìm và **bật "Google Sheets API"** cho Project của bạn.</li>
                            </ul>
                        </li>
                        <li><strong>Kiểm tra quyền truy cập Sheet:</strong>
                            <ul>
                                <li>Mở Google Sheet: <a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}" target="_blank">Mở Sheet</a></li>
                                <li>Nhấn "Share" và đặt quyền là **"Anyone with the link can view"** (Công khai)</li>
                            </ul>
                        </li>
                    </ol>
                `;
            } else if (error.message.includes('404') || error.message.includes('Unable to parse range')) {
                errorHTML += `
                    <h4><i class="fas fa-tools"></i> Khắc phục lỗi 404 (Not Found) / Range:</h4>
                    <ol>
                        <li><strong>Kiểm tra Sheet ID:</strong> <code>${SHEET_ID}</code> (Đảm bảo ID là đúng)</li>
                        <li><strong>Kiểm tra tên Sheet/Range:</strong> Đảm bảo tên sheet <code>Nhập đơn hàng kiểm kê</code> và range <code>A:O</code> là chính xác.</li>
                    </ol>
                `;
            } else {
                errorHTML += `
                    <h4><i class="fas fa-tools"></i> Các bước kiểm tra chung:</h4>
                    <ol>
                        <li>Thử refresh trang và load lại</li>
                        <li>Kiểm tra browser console (F12) để xem lỗi chi tiết</li>
                    </ol>
                `;
            }

            errorHTML += `
                    <br>
                    <h4><i class="fas fa-info-circle"></i> Thông tin kết nối hiện tại:</h4>
                    <ul>
                        <li><strong>Sheet ID:</strong> <code>${SHEET_ID}</code></li>
                        <li><strong>Range:</strong> <code>${RANGE}</code></li>
                        <li><strong>URL API:</strong> <a href="https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}" target="_blank">Test trong browser</a></li>
                    </ul>
                    <br>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <strong>💡 Gợi ý:</strong> Nhấn vào link "Test trong browser" ở trên để kiểm tra trực tiếp API response và thông báo lỗi của Google.
                    </div>
                </div>
            `;

            status.innerHTML = errorHTML;
            status.className = 'status error';
            
            // Ẩn bảng và thống kê khi có lỗi
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
        }

        // Điền dữ liệu vào dropdown vị trí
        function populatePositionFilter() {
            const positions = [...new Set(allData.map(item => item.viTri).filter(pos => pos))];
            const select = document.getElementById('positionFilter');
            
            // Xóa các option cũ (trừ option đầu tiên)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            positions.sort().forEach(position => {
                const option = document.createElement('option');
                option.value = position;
                option.textContent = position;
                select.appendChild(option);
            });
        }

        // Áp dụng bộ lọc
        function applyFilters() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const position = document.getElementById('positionFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredData = allData.filter(item => {
                // Lọc theo ngày
                if (fromDate && item.ngayNhap) {
                    const itemDate = new Date(item.ngayNhap);
                    const filterFromDate = new Date(fromDate);
                    // Đảm bảo không lọc các ngày không hợp lệ
                    if (!isNaN(itemDate) && itemDate < filterFromDate) return false;
                }
                
                if (toDate && item.ngayNhap) {
                    const itemDate = new Date(item.ngayNhap);
                    const filterToDate = new Date(toDate);
                    // Chỉnh ngày lọc đến ngày cuối để bao gồm cả ngày đó
                    filterToDate.setDate(filterToDate.getDate() + 1); 
                    if (!isNaN(itemDate) && itemDate >= filterToDate) return false;
                }

                // Lọc theo vị trí
                if (position && item.viTri !== position) return false;

                // Tìm kiếm
                if (searchTerm) {
                    const searchableText = Object.values(item).join(' ').toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }

                return true;
            });

            displayData();
            updateStats();
        }

        // Hiển thị dữ liệu trong bảng 
        function displayData() {
            const tbody = document.getElementById('dataBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            tbody.innerHTML = '';

            filteredData.forEach(item => {
                const row = document.createElement('tr');
                
                const cells = [
                    item.orderKD, item.tenChiTiet, item.soFile, item.sll, item.qrCode,
                    item.viTri, item.slKiemDem, item.tuThung, item.denThung, item.checkQR,
                    item.ghiChu, item.code, item.hoVaTen, item.ngayNhap, item.trangThai
                ];

                cells.forEach((cellValue, index) => {
                    const cell = document.createElement('td');
                    cellValue = String(cellValue); // Đảm bảo cellValue là string
                    
                    if (searchTerm && cellValue.toLowerCase().includes(searchTerm)) {
                        cell.innerHTML = highlightText(cellValue, searchTerm);
                    } else {
                        cell.textContent = cellValue;
                    }
                    
                    // XỬ LÝ ĐỊNH DẠNG CỘT TRẠNG THÁI (index 14)
                    if (index === 14) {
                        cell.classList.add('status-cell');
                        if (cellValue.trim().toLowerCase() === 'đã kiểm kê') {
                            // Thay thế nội dung bằng một thẻ badge có class màu xanh
                            cell.innerHTML = `<span class="status-badge da-kiem-ke">${cellValue}</span>`;
                        } else {
                            // Nếu có các trạng thái khác, có thể thêm class khác ở đây
                            cell.textContent = cellValue;
                        }
                    }
                    // KẾT THÚC XỬ LÝ ĐỊNH DẠNG CỘT TRẠNG THÁI
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        // Highlight text tìm kiếm
        function highlightText(text, searchTerm) {
            // Escape special characters in the search term for regex
            const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // Cập nhật thống kê
        function updateStats() {
            document.getElementById('totalRecords').textContent = allData.length;
            document.getElementById('filteredRecords').textContent = filteredData.length;

            // Tính Tổng SLL từ dữ liệu đã lọc
            const totalSLL = filteredData.reduce((sum, item) => {
                // Đảm bảo item.sll là một số hợp lệ trước khi cộng
                const sllValue = parseInt(item.sll);
                return sum + (isNaN(sllValue) ? 0 : sllValue);
            }, 0);

            // Hiển thị Tổng SLL đã tính
            document.getElementById('totalSLL').textContent = totalSLL.toLocaleString('en-US'); 
            
            const uniquePositions = new Set(filteredData.map(item => item.viTri).filter(pos => pos));
            document.getElementById('uniquePositions').textContent = uniquePositions.size;
        }

        // Xuất Excel
        function exportToExcel() {
            if (filteredData.length === 0) {
                showStatus('Không có dữ liệu để xuất!', 'error');
                return;
            }

            try {
                // Tạo workbook
                const wb = XLSX.utils.book_new();
                
                // Tạo header
                const headers = [
                    'Order KD', 'Tên chi tiết', 'Số file', 'SLL', 'QR code',
                    'Vị trí', 'SL kiểm đếm', 'Từ thùng', 'Đến thùng', 'Check QR code',
                    'Ghi chú', 'Code', 'Họ và tên', 'Ngày nhập', 'Trạng thái'
                ];

                // Tạo dữ liệu cho worksheet
                const wsData = [headers];
                
                filteredData.forEach(item => {
                    wsData.push([
                        item.orderKD, item.tenChiTiet, item.soFile, item.sll, item.qrCode,
                        item.viTri, item.slKiemDem, item.tuThung, item.denThung, item.checkQR,
                        item.ghiChu, item.code, item.hoVaTen, item.ngayNhap, item.trangThai
                    ]);
                });

                // Tạo worksheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Thiết lập độ rộng cột
                const colWidths = [
                    { wch: 12 }, { wch: 30 }, { wch: 15 }, { wch: 10 }, { wch: 25 }, 
                    { wch: 15 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, 
                    { wch: 20 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 15 }
                ];
                ws['!cols'] = colWidths;

                // Thêm worksheet vào workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Kiểm kê đơn hàng');

                // Tạo tên file dựa theo bộ lọc
                const filename = generateFileName();

                // Xuất file
                XLSX.writeFile(wb, filename);
                
                showStatus(`📤 Đã xuất thành công ${filteredData.length} bản ghi vào file "${filename}"!`, 'success');
                
            } catch (error) {
                console.error('Lỗi khi xuất Excel:', error);
                showStatus(`Lỗi khi xuất Excel: ${error.message}`, 'error');
            }
        }

        // Tạo tên file dựa theo ngày nhập thực tế và vị trí từ dữ liệu
        function generateFileName() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const position = document.getElementById('positionFilter').value;
            
            let fileName = 'KiemKeDonHang';
            
            // Lấy ngày nhập từ dữ liệu thực tế
            if (filteredData.length > 0) {
                const dates = filteredData
                    .map(item => item.ngayNhap)
                    .filter(date => date && date.trim() !== '')
                    .map(date => {
                        // Xử lý nhiều format ngày
                        if (date.includes('/')) {
                            const parts = date.split('/');
                            if (parts.length === 3) {
                                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            }
                        } else if (date.includes('-')) {
                            const parts = date.split('-');
                            if (parts.length === 3) {
                                if (parts[0].length === 4) {
                                    return date; 
                                } else {
                                    return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                                }
                            }
                        }
                        return date;
                    })
                    .filter(dateStr => !isNaN(new Date(dateStr))) 
                    .sort();

                if (dates.length > 0) {
                    const firstDate = dates[0];
                    const lastDate = dates[dates.length - 1];
                    
                    const formatDateForFile = (dateStr) => {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            return date.toISOString().slice(0, 10).replace(/-/g, '');
                        }
                        return dateStr.replace(/[-/]/g, '');
                    };

                    const firstFormatted = formatDateForFile(firstDate);
                    const lastFormatted = formatDateForFile(lastDate);
                    
                    if (firstFormatted === lastFormatted) {
                        fileName += `_${firstFormatted}`;
                    } else {
                        fileName += `_${firstFormatted}_den_${lastFormatted}`;
                    }
                }
            } else if (fromDate && toDate) {
                // Fallback về bộ lọc nếu không có dữ liệu
                const fromFormatted = fromDate.replace(/-/g, '');
                const toFormatted = toDate.replace(/-/g, '');
                if (fromFormatted === toFormatted) {
                    fileName += `_${fromFormatted}`;
                } else {
                    fileName += `_${fromFormatted}_den_${toFormatted}`;
                }
            }
            
            // Lấy vị trí từ dữ liệu hoặc bộ lọc
            let positionForFile = '';
            if (position) {
                positionForFile = position;
            } else if (filteredData.length > 0) {
                const positions = filteredData
                    .map(item => item.viTri)
                    .filter(pos => pos && pos.trim() !== '');
                
                if (positions.length > 0) {
                    const positionCount = {};
                    positions.forEach(pos => {
                        positionCount[pos] = (positionCount[pos] || 0) + 1;
                    });
                    
                    positionForFile = Object.keys(positionCount).reduce((a, b) => 
                        positionCount[a] > positionCount[b] ? a : b
                    );
                }
            }
            
            // Format vị trí cho tên file
            if (positionForFile) {
                const positionFormatted = positionForFile
                    .toLowerCase()
                    .replace(/\s+/g, '-')  
                    .replace(/[^a-zA-Z0-9\-]/g, '')  
                    .replace(/\-+/g, '-')  
                    .replace(/^\-|\-$/g, ''); 
                
                if (positionFormatted) {
                    fileName += `_${positionFormatted}`;
                }
            }
            
            // Thêm timestamp nếu không có thông tin ngày (để tránh tên file trùng lặp)
            if (fileName.length < 20) {
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 10).replace(/-/g, '');
                if (!fileName.includes(timestamp)) {
                    fileName += `_${timestamp}`;
                }
            }
            
            return fileName + '.xlsx';
        }

        // Xóa bộ lọc
        function clearFilters() {
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            document.getElementById('positionFilter').value = '';
            document.getElementById('searchInput').value = '';
            
            if (allData.length > 0) {
                applyFilters();
                showStatus('Đã xóa tất cả bộ lọc!', 'success');
            } else {
                showStatus('Vui lòng tải dữ liệu trước khi xóa bộ lọc!', 'loading');
            }
        }

        // Event listeners
        document.getElementById('fromDate').addEventListener('change', applyFilters);
        document.getElementById('toDate').addEventListener('change', applyFilters);
        document.getElementById('positionFilter').addEventListener('change', applyFilters);
        
        // Debounce search input
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        });

        // Khởi tạo trang (ĐÃ BỔ SUNG TỰ ĐỘNG TẢI DỮ LIỆU)
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            loadData(); 
        });
        
    </script>
</body>
</html>
