<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm K√™ ƒê∆°n H√†ng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdL5b8719875F07+vL49R462Q519hL31v2R2Ff8e0Q5Fp0B+p0Qv6j+Q/Q0C6G51R7G0F61O+q5Fp0B+p0Qv6j+Q/Q0C6G51R7G0F61O+q5Fp0B+p0Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Thi·∫øt l·∫≠p chung */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif; /* Font hi·ªán ƒë·∫°i h∆°n */
            background-color: #f4f7fa; /* N·ªÅn s√°ng, nh·∫π nh√†ng */
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1800px; /* ƒê√É M·ªû R·ªòNG: TƒÉng k√≠ch th∆∞·ªõc t·ªëi ƒëa c·ªßa container */
            margin: 0 auto;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); 
            overflow: hidden;
        }

        /* Header */
        .header {
            background-color: #2c3e50; /* M√†u t·ªëi, sang tr·ªçng */
            padding: 30px;
            text-align: center;
            color: white;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.8;
        }

        /* Controls v√† Filters */
        .controls {
            padding: 25px 30px;
            background-color: #ffffff;
            border-bottom: 1px solid #e5e9ec;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .form-group label i {
            margin-right: 8px;
            color: #3498db;
        }

        .form-group input, .form-group select {
            padding: 10px 15px;
            border: 1px solid #dcdfe4;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f7f9fb;
            color: #2c3e50;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            background: white;
        }

        .search-container {
            position: relative;
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px 12px 50px; /* Th√™m padding b√™n tr√°i cho icon */
            border: 1px solid #dcdfe4;
            border-radius: 50px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f7f9fb;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 20px; /* Di chuy·ªÉn icon sang tr√°i */
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
            font-size: 1rem;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 50px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #3498db; /* Xanh d∆∞∆°ng */
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background-color: #2ecc71; /* Xanh l√° */
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-warning {
            background-color: #f39c12; /* V√†ng cam */
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(243, 156, 18, 0.3);
        }

        /* Content v√† Status */
        .content {
            padding: 30px;
        }

        .status {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
            border-left: 5px solid; /* ƒêi·ªÉm nh·∫•n tr·∫°ng th√°i */
        }

        .status.loading {
            background-color: #ecf0f1;
            color: #34495e;
            border-color: #95a5a6;
            display: flex;
            align-items: center;
        }

        .status.success {
            background-color: #e8f9f2;
            color: #27ae60;
            border-color: #2ecc71;
            display: block;
        }

        .status.error {
            background-color: #fde8e8;
            color: #c0392b;
            border-color: #e74c3c;
            display: block;
            max-height: 450px;
            overflow-y: auto;
        }

        .status.error h3 {
            margin-bottom: 10px;
            color: #e74c3c;
            font-size: 1.2rem;
        }
        
        /* C·∫£i ti·∫øn hi·ªÉn th·ªã l·ªói */
        .status.error ol, .status.error ul {
            margin: 10px 0 10px 20px;
            padding-left: 0;
            list-style-type: disc;
        }

        .status.error li {
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 0.95rem;
        }
        
        .status.error a {
            color: #2980b9;
            text-decoration: none;
        }
        
        .status.error a:hover {
            text-decoration: underline;
        }
        
        .status.error code {
            background-color: #f7f9fb;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #e74c3c;
        }


        /* Th·ªëng k√™ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #ffffff;
            color: #2c3e50;
            padding: 25px;
            border-radius: 12px;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #3498db; /* ƒêi·ªÉm nh·∫•n m√†u xanh */
            transition: all 0.3s ease;
        }

        /* THAY ƒê·ªîI CSS ·ªû ƒê√ÇY: Th√™m 1 th·∫ª stat-card n·ªØa */
        .stat-card:nth-child(2) { border-left-color: #2ecc71; } /* Xanh l√° */
        .stat-card:nth-child(3) { border-left-color: #f39c12; } /* V√†ng cam (Cho T·ªïng SLL) */
        .stat-card:nth-child(4) { border-left-color: #e74c3c; } /* ƒê·ªè (Cho V·ªã tr√≠ kh√°c nhau) */


        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #3498db; /* M√†u n·ªïi b·∫≠t */
        }
        
        .stat-card:nth-child(2) .stat-number { color: #2ecc71; }
        .stat-card:nth-child(3) .stat-number { color: #f39c12; } /* M√†u cho T·ªïng SLL */
        .stat-card:nth-child(4) .stat-number { color: #e74c3c; } /* M√†u cho V·ªã tr√≠ kh√°c nhau */


        .stat-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* B·∫£ng D·ªØ li·ªáu */
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e9ec;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th {
            background-color: #34495e; /* M√†u n·ªÅn header t·ªëi */
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 3px solid #3498db;
            white-space: nowrap;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9rem;
            vertical-align: middle;
            color: #34495e;
        }

        .data-table tr:hover {
            background-color: #fcfdfe; /* Hi·ªáu ·ª©ng hover nh·∫π */
        }

        .highlight {
            background-color: #fcf3cf; /* M√†u v√†ng nh·∫°t */
            color: #8b600a;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* CSS B·ªî SUNG CHO C·ªòT TR·∫†NG TH√ÅI */
        .status-cell {
            text-align: center;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .da-kiem-ke {
            background-color: #e8f9f2; /* M√†u n·ªÅn xanh l√° nh·∫°t */
            color: #27ae60; /* M√†u ch·ªØ xanh l√° ƒë·∫≠m */
        }
        /* K·∫æT TH√öC CSS B·ªî SUNG */


        /* Responsive */
        @media (max-width: 992px) {
            .filter-group {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
            .stats {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* ƒêi·ªÅu ch·ªânh l·∫°i grid cho stats */
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }
            .header h1 {
                font-size: 1.8rem;
            }
            .controls, .content {
                padding: 15px;
            }
            .button-group {
                justify-content: center;
            }
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            .data-table th, .data-table td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-warehouse"></i>Ki·ªÉm K√™ ƒê∆°n H√†ng</h1>
            <p>Qu·∫£n l√Ω, t√¨m ki·∫øm v√† xu·∫•t d·ªØ li·ªáu ki·ªÉm k√™ t·ª´ AppSheet</p>
        </div>

        <div class="controls">
            <div class="filter-group">
                <div class="form-group">
                    <label for="fromDate"><i class="fas fa-calendar-alt"></i> T·ª´ ng√†y:</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="form-group">
                    <label for="toDate"><i class="fas fa-calendar-alt"></i> ƒê·∫øn ng√†y:</label>
                    <input type="date" id="toDate">
                </div>
                <div class="form-group">
                    <label for="positionFilter"><i class="fas fa-map-marker-alt"></i> V·ªã tr√≠:</label>
                    <select id="positionFilter">
                        <option value="">-- T·∫•t c·∫£ v·ªã tr√≠ --</option>
                    </select>
                </div>
            </div>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="T√¨m ki·∫øm Order KD, T√™n chi ti·∫øt, QR code...">
                <span class="search-icon"><i class="fas fa-search"></i></span>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="loadData()">
                    <span id="loadText"><i class="fas fa-download"></i> T·∫£i d·ªØ li·ªáu</span>
                </button>
                <button class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                </button>
                <button class="btn btn-warning" onclick="clearFilters()">
                    <i class="fas fa-sync-alt"></i> X√≥a b·ªô l·ªçc
                </button>
            </div>
        </div>

        <div class="content">
            <div id="status" class="status"></div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-label">T·ªïng s·ªë ƒë∆°n h√†ng</div>
                    <div class="stat-number" id="totalRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">T·ªïng s·ªë ƒë∆°n h√†ng theo khu v·ª±c</div>
                    <div class="stat-number" id="filteredRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">T·ªïng s·ªë l∆∞·ª£ng</div>
                    <div class="stat-number" id="totalSLL">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Khu v·ª±c ki·ªÉm k√™</div>
                    <div class="stat-number" id="uniquePositions">0</div>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table" id="dataTable" style="display: none;">
                    <thead>
                        <tr>
                            <th><i class="fas fa-clipboard-list"></i> Order KD</th>
                            <th><i class="fas fa-tag"></i> T√™n chi ti·∫øt</th>
                            <th><i class="fas fa-file-alt"></i> S·ªë file</th>
                            <th><i class="fas fa-sort-numeric-up"></i> SLL</th>
                            <th><i class="fas fa-qrcode"></i> QR code</th>
                            <th><i class="fas fa-map-pin"></i> V·ªã tr√≠</th>
                            <th><i class="fas fa-check-double"></i> SL ki·ªÉm ƒë·∫øm</th>
                            <th><i class="fas fa-box-open"></i> T·ª´ th√πng</th>
                            <th><i class="fas fa-box"></i> ƒê·∫øn th√πng</th>
                            <th><i class="fas fa-qrcode"></i> Check QR</th>
                            <th><i class="fas fa-comment-dots"></i> Ghi ch√∫</th>
                            <th><i class="fas fa-code"></i> Code</th>
                            <th><i class="fas fa-user-circle"></i> H·ªç v√† t√™n</th>
                            <th><i class="fas fa-calendar-check"></i> Ng√†y nh·∫≠p</th>
                            <th><i class="fas fa-hourglass-half"></i> Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- C·∫¶N THAY TH·∫æ SHEET_ID v√† API_KEY C·ª¶A B·∫†N V√ÄO ƒê√ÇY ---
        const SHEET_ID = '1uWHw7ME46tF5bkB0vrUM-Ubi982k4l3sHuqYcy3dFF4'; // Thay b·∫±ng Sheet ID th·ª±c t·∫ø
        const API_KEY = 'AIzaSyCrC_DfD_DrpjzjO5ENvqTMHBA4FIDBiP0'; // Thay b·∫±ng API Key th·ª±c t·∫ø
        const RANGE = 'Nh·∫≠p ƒë∆°n h√†ng ki·ªÉm k√™!A:O'; 
        
        let allData = [];
        let filteredData = [];

        // Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh
        function setDefaultDates() {
            const today = new Date();
            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('fromDate').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('toDate').value = today.toISOString().split('T')[0];
        }

        // Hi·ªÉn th·ªã tr·∫°ng th√°i
        function showStatus(message, type) {
            const status = document.getElementById('status');
            // Th√™m spinner cho tr·∫°ng th√°i loading
            if (type === 'loading') {
                status.innerHTML = `<span class="loading-spinner"></span> ${message}`;
            } else {
                status.textContent = message;
            }
            status.className = `status ${type}`;
        }

        // T·∫£i d·ªØ li·ªáu t·ª´ AppSheet API
        async function loadData() {
            const loadButton = document.querySelector('.btn-primary');
            const loadText = document.getElementById('loadText');
            
            loadButton.disabled = true;
            loadText.innerHTML = '<span class="loading-spinner"></span> ƒêang t·∫£i...';
            showStatus('ƒêang k·∫øt n·ªëi AppSheet API...', 'loading');

            try {
                // Ch·ªâ s·ª≠ d·ª•ng AppSheet API
                const data = await fetchGoogleSheetsData();
                
                if (!data || !data.values || data.values.length === 0) {
                    throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu trong b·∫£ng t√≠nh ho·∫∑c kh√¥ng th·ªÉ truy c·∫≠p');
                }

                // Ki·ªÉm tra header
                const headers = data.values[0];
                console.log('Headers t·ª´ AppSheet:', headers);

                // B·ªè qua h√†ng ƒë·∫ßu ti√™n (header) v√† x·ª≠ l√Ω d·ªØ li·ªáu
                const rows = data.values.slice(1);
                
                allData = rows.map((row, index) => {
                    // ƒê·∫£m b·∫£o m·ªói row c√≥ ƒë·ªß 15 c·ªôt
                    while (row.length < 15) {
                        row.push('');
                    }
                    
                    return {
                        orderKD: row[0] || '',
                        tenChiTiet: row[1] || '',
                        soFile: row[2] || '',
                        sll: row[3] || '',
                        qrCode: row[4] || '',
                        viTri: row[5] || '',
                        slKiemDem: row[6] || '',
                        tuThung: row[7] || '',
                        denThung: row[8] || '',
                        checkQR: row[9] || '',
                        ghiChu: row[10] || '',
                        code: row[11] || '',
                        hoVaTen: row[12] || '',
                        ngayNhap: row[13] || '',
                        trangThai: row[14] || ''
                    };
                });

                // Lo·∫°i b·ªè c√°c d√≤ng tr·ªëng
                allData = allData.filter(row => 
                    Object.values(row).some(value => value && value.trim() !== '')
                );

                populatePositionFilter();
                applyFilters();
                showStatus(`‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng ${allData.length} b·∫£n ghi t·ª´ AppSheet!`, 'success');
                
                // Hi·ªÉn th·ªã b·∫£ng v√† th·ªëng k√™
                document.getElementById('dataTable').style.display = 'table';
                document.getElementById('stats').style.display = 'grid';
                
            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                showGoogleSheetsError(error);
            } finally {
                loadButton.disabled = false;
                loadText.innerHTML = '<i class="fas fa-download"></i> T·∫£i d·ªØ li·ªáu';
            }
        }

        // Fetch d·ªØ li·ªáu t·ª´ AppSheet API
        async function fetchGoogleSheetsData() {
            // S·ª¨ D·ª§NG V4 API
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            
            console.log('ƒêang g·ªçi API:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorBody = await response.text();
                console.log('Error response body:', errorBody);
                
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorJson = JSON.parse(errorBody);
                    if (errorJson.error && errorJson.error.message) {
                        errorMessage += `: ${errorJson.error.message}`;
                    }
                } catch (e) {
                    errorMessage += `: ${errorBody}`;
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            console.log('D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:', {
                totalRows: data.values ? data.values.length : 0,
                firstRow: data.values ? data.values[0] : null
            });

            return data;
        }

        // Hi·ªÉn th·ªã l·ªói AppSheet v·ªõi h∆∞·ªõng d·∫´n chi ti·∫øt
        function showGoogleSheetsError(error) {
            const status = document.getElementById('status');
            
            let errorHTML = `
                <div style="text-align: left;">
                    <h3><i class="fas fa-exclamation-triangle"></i> L·ªói K·∫øt N·ªëi Google Sheets API</h3>
                    <p><strong>L·ªói:</strong> ${error.message}</p>
                    <br>
            `;

            if (error.message.includes('403') || error.message.includes('API key not valid')) {
                errorHTML += `
                    <h4><i class="fas fa-tools"></i> Kh·∫Øc ph·ª•c l·ªói 403 (Forbidden) ho·∫∑c API Key:</h4>
                    <ol>
                        <li><strong>Ki·ªÉm tra API Key:</strong>
                            <ul>
                                <li>Truy c·∫≠p <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></li>
                                <li>ƒê·∫£m b·∫£o API key: <code>${API_KEY.substring(0, 10)}...</code> c√≤n hi·ªáu l·ª±c</li>
                                <li>Ki·ªÉm tra quota v√† usage limits</li>
                            </ul>
                        </li>
                        <li><strong>B·∫≠t Sheets API:</strong>
                            <ul>
                                <li>Trong Google Cloud Console, t√¨m v√† **b·∫≠t "Google Sheets API"** cho Project c·ªßa b·∫°n.</li>
                            </ul>
                        </li>
                        <li><strong>Ki·ªÉm tra quy·ªÅn truy c·∫≠p Sheet:</strong>
                            <ul>
                                <li>M·ªü Google Sheet: <a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}" target="_blank">M·ªü Sheet</a></li>
                                <li>Nh·∫•n "Share" v√† ƒë·∫∑t quy·ªÅn l√† **"Anyone with the link can view"** (C√¥ng khai)</li>
                            </ul>
                        </li>
                    </ol>
                `;
            } else if (error.message.includes('404') || error.message.includes('Unable to parse range')) {
                errorHTML += `
                    <h4><i class="fas fa-tools"></i> Kh·∫Øc ph·ª•c l·ªói 404 (Not Found) / Range:</h4>
                    <ol>
                        <li><strong>Ki·ªÉm tra Sheet ID:</strong> <code>${SHEET_ID}</code> (ƒê·∫£m b·∫£o ID l√† ƒë√∫ng)</li>
                        <li><strong>Ki·ªÉm tra t√™n Sheet/Range:</strong> ƒê·∫£m b·∫£o t√™n sheet <code>Nh·∫≠p ƒë∆°n h√†ng ki·ªÉm k√™</code> v√† range <code>A:O</code> l√† ch√≠nh x√°c.</li>
                    </ol>
                `;
            } else {
                errorHTML += `
                    <h4><i class="fas fa-tools"></i> C√°c b∆∞·ªõc ki·ªÉm tra chung:</h4>
                    <ol>
                        <li>Th·ª≠ refresh trang v√† load l·∫°i</li>
                        <li>Ki·ªÉm tra browser console (F12) ƒë·ªÉ xem l·ªói chi ti·∫øt</li>
                    </ol>
                `;
            }

            errorHTML += `
                    <br>
                    <h4><i class="fas fa-info-circle"></i> Th√¥ng tin k·∫øt n·ªëi hi·ªán t·∫°i:</h4>
                    <ul>
                        <li><strong>Sheet ID:</strong> <code>${SHEET_ID}</code></li>
                        <li><strong>Range:</strong> <code>${RANGE}</code></li>
                        <li><strong>URL API:</strong> <a href="https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}" target="_blank">Test trong browser</a></li>
                    </ul>
                    <br>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <strong>üí° G·ª£i √Ω:</strong> Nh·∫•n v√†o link "Test trong browser" ·ªü tr√™n ƒë·ªÉ ki·ªÉm tra tr·ª±c ti·∫øp API response v√† th√¥ng b√°o l·ªói c·ªßa Google.
                    </div>
                </div>
            `;

            status.innerHTML = errorHTML;
            status.className = 'status error';
            
            // ·∫®n b·∫£ng v√† th·ªëng k√™ khi c√≥ l·ªói
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
        }

        // ƒêi·ªÅn d·ªØ li·ªáu v√†o dropdown v·ªã tr√≠
        function populatePositionFilter() {
            const positions = [...new Set(allData.map(item => item.viTri).filter(pos => pos))];
            const select = document.getElementById('positionFilter');
            
            // X√≥a c√°c option c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            positions.sort().forEach(position => {
                const option = document.createElement('option');
                option.value = position;
                option.textContent = position;
                select.appendChild(option);
            });
        }

        // √Åp d·ª•ng b·ªô l·ªçc
        function applyFilters() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const position = document.getElementById('positionFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredData = allData.filter(item => {
                // L·ªçc theo ng√†y
                if (fromDate && item.ngayNhap) {
                    const itemDate = new Date(item.ngayNhap);
                    const filterFromDate = new Date(fromDate);
                    // ƒê·∫£m b·∫£o kh√¥ng l·ªçc c√°c ng√†y kh√¥ng h·ª£p l·ªá
                    if (!isNaN(itemDate) && itemDate < filterFromDate) return false;
                }
                
                if (toDate && item.ngayNhap) {
                    const itemDate = new Date(item.ngayNhap);
                    const filterToDate = new Date(toDate);
                    // Ch·ªânh ng√†y l·ªçc ƒë·∫øn ng√†y cu·ªëi ƒë·ªÉ bao g·ªìm c·∫£ ng√†y ƒë√≥
                    filterToDate.setDate(filterToDate.getDate() + 1); 
                    if (!isNaN(itemDate) && itemDate >= filterToDate) return false;
                }

                // L·ªçc theo v·ªã tr√≠
                if (position && item.viTri !== position) return false;

                // T√¨m ki·∫øm
                if (searchTerm) {
                    const searchableText = Object.values(item).join(' ').toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }

                return true;
            });

            displayData();
            updateStats();
        }

        // Hi·ªÉn th·ªã d·ªØ li·ªáu trong b·∫£ng 
        function displayData() {
            const tbody = document.getElementById('dataBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            tbody.innerHTML = '';

            filteredData.forEach(item => {
                const row = document.createElement('tr');
                
                const cells = [
                    item.orderKD, item.tenChiTiet, item.soFile, item.sll, item.qrCode,
                    item.viTri, item.slKiemDem, item.tuThung, item.denThung, item.checkQR,
                    item.ghiChu, item.code, item.hoVaTen, item.ngayNhap, item.trangThai
                ];

                cells.forEach((cellValue, index) => {
                    const cell = document.createElement('td');
                    cellValue = String(cellValue); // ƒê·∫£m b·∫£o cellValue l√† string
                    
                    if (searchTerm && cellValue.toLowerCase().includes(searchTerm)) {
                        cell.innerHTML = highlightText(cellValue, searchTerm);
                    } else {
                        cell.textContent = cellValue;
                    }
                    
                    // X·ª¨ L√ù ƒê·ªäNH D·∫†NG C·ªòT TR·∫†NG TH√ÅI (index 14)
                    if (index === 14) {
                        cell.classList.add('status-cell');
                        if (cellValue.trim().toLowerCase() === 'ƒë√£ ki·ªÉm k√™') {
                            // Thay th·∫ø n·ªôi dung b·∫±ng m·ªôt th·∫ª badge c√≥ class m√†u xanh
                            cell.innerHTML = `<span class="status-badge da-kiem-ke">${cellValue}</span>`;
                        } else {
                            // N·∫øu c√≥ c√°c tr·∫°ng th√°i kh√°c, c√≥ th·ªÉ th√™m class kh√°c ·ªü ƒë√¢y
                            cell.textContent = cellValue;
                        }
                    }
                    // K·∫æT TH√öC X·ª¨ L√ù ƒê·ªäNH D·∫†NG C·ªòT TR·∫†NG TH√ÅI
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        // Highlight text t√¨m ki·∫øm
        function highlightText(text, searchTerm) {
            // Escape special characters in the search term for regex
            const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats() {
            document.getElementById('totalRecords').textContent = allData.length;
            document.getElementById('filteredRecords').textContent = filteredData.length;

            // T√≠nh T·ªïng SLL t·ª´ d·ªØ li·ªáu ƒë√£ l·ªçc
            const totalSLL = filteredData.reduce((sum, item) => {
                // ƒê·∫£m b·∫£o item.sll l√† m·ªôt s·ªë h·ª£p l·ªá tr∆∞·ªõc khi c·ªông
                const sllValue = parseInt(item.sll);
                return sum + (isNaN(sllValue) ? 0 : sllValue);
            }, 0);

            // Hi·ªÉn th·ªã T·ªïng SLL ƒë√£ t√≠nh
            document.getElementById('totalSLL').textContent = totalSLL.toLocaleString('en-US'); 
            
            const uniquePositions = new Set(filteredData.map(item => item.viTri).filter(pos => pos));
            document.getElementById('uniquePositions').textContent = uniquePositions.size;
        }

        // Xu·∫•t Excel
        function exportToExcel() {
            if (filteredData.length === 0) {
                showStatus('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
                return;
            }

            try {
                // T·∫°o workbook
                const wb = XLSX.utils.book_new();
                
                // T·∫°o header
                const headers = [
                    'Order KD', 'T√™n chi ti·∫øt', 'S·ªë file', 'SLL', 'QR code',
                    'V·ªã tr√≠', 'SL ki·ªÉm ƒë·∫øm', 'T·ª´ th√πng', 'ƒê·∫øn th√πng', 'Check QR code',
                    'Ghi ch√∫', 'Code', 'H·ªç v√† t√™n', 'Ng√†y nh·∫≠p', 'Tr·∫°ng th√°i'
                ];

                // T·∫°o d·ªØ li·ªáu cho worksheet
                const wsData = [headers];
                
                filteredData.forEach(item => {
                    wsData.push([
                        item.orderKD, item.tenChiTiet, item.soFile, item.sll, item.qrCode,
                        item.viTri, item.slKiemDem, item.tuThung, item.denThung, item.checkQR,
                        item.ghiChu, item.code, item.hoVaTen, item.ngayNhap, item.trangThai
                    ]);
                });

                // T·∫°o worksheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Thi·∫øt l·∫≠p ƒë·ªô r·ªông c·ªôt
                const colWidths = [
                    { wch: 12 }, { wch: 30 }, { wch: 15 }, { wch: 10 }, { wch: 25 }, 
                    { wch: 15 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, 
                    { wch: 20 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 15 }
                ];
                ws['!cols'] = colWidths;

                // Th√™m worksheet v√†o workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Ki·ªÉm k√™ ƒë∆°n h√†ng');

                // T·∫°o t√™n file d·ª±a theo b·ªô l·ªçc
                const filename = generateFileName();

                // Xu·∫•t file
                XLSX.writeFile(wb, filename);
                
                showStatus(`üì§ ƒê√£ xu·∫•t th√†nh c√¥ng ${filteredData.length} b·∫£n ghi v√†o file "${filename}"!`, 'success');
                
            } catch (error) {
                console.error('L·ªói khi xu·∫•t Excel:', error);
                showStatus(`L·ªói khi xu·∫•t Excel: ${error.message}`, 'error');
            }
        }

        // T·∫°o t√™n file d·ª±a theo ng√†y nh·∫≠p th·ª±c t·∫ø v√† v·ªã tr√≠ t·ª´ d·ªØ li·ªáu
        function generateFileName() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const position = document.getElementById('positionFilter').value;
            
            let fileName = 'KiemKeDonHang';
            
            // L·∫•y ng√†y nh·∫≠p t·ª´ d·ªØ li·ªáu th·ª±c t·∫ø
            if (filteredData.length > 0) {
                const dates = filteredData
                    .map(item => item.ngayNhap)
                    .filter(date => date && date.trim() !== '')
                    .map(date => {
                        // X·ª≠ l√Ω nhi·ªÅu format ng√†y
                        if (date.includes('/')) {
                            const parts = date.split('/');
                            if (parts.length === 3) {
                                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            }
                        } else if (date.includes('-')) {
                            const parts = date.split('-');
                            if (parts.length === 3) {
                                if (parts[0].length === 4) {
                                    return date; 
                                } else {
                                    return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                                }
                            }
                        }
                        return date;
                    })
                    .filter(dateStr => !isNaN(new Date(dateStr))) 
                    .sort();

                if (dates.length > 0) {
                    const firstDate = dates[0];
                    const lastDate = dates[dates.length - 1];
                    
                    const formatDateForFile = (dateStr) => {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            return date.toISOString().slice(0, 10).replace(/-/g, '');
                        }
                        return dateStr.replace(/[-/]/g, '');
                    };

                    const firstFormatted = formatDateForFile(firstDate);
                    const lastFormatted = formatDateForFile(lastDate);
                    
                    if (firstFormatted === lastFormatted) {
                        fileName += `_${firstFormatted}`;
                    } else {
                        fileName += `_${firstFormatted}_den_${lastFormatted}`;
                    }
                }
            } else if (fromDate && toDate) {
                // Fallback v·ªÅ b·ªô l·ªçc n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
                const fromFormatted = fromDate.replace(/-/g, '');
                const toFormatted = toDate.replace(/-/g, '');
                if (fromFormatted === toFormatted) {
                    fileName += `_${fromFormatted}`;
                } else {
                    fileName += `_${fromFormatted}_den_${toFormatted}`;
                }
            }
            
            // L·∫•y v·ªã tr√≠ t·ª´ d·ªØ li·ªáu ho·∫∑c b·ªô l·ªçc
            let positionForFile = '';
            if (position) {
                positionForFile = position;
            } else if (filteredData.length > 0) {
                const positions = filteredData
                    .map(item => item.viTri)
                    .filter(pos => pos && pos.trim() !== '');
                
                if (positions.length > 0) {
                    const positionCount = {};
                    positions.forEach(pos => {
                        positionCount[pos] = (positionCount[pos] || 0) + 1;
                    });
                    
                    positionForFile = Object.keys(positionCount).reduce((a, b) => 
                        positionCount[a] > positionCount[b] ? a : b
                    );
                }
            }
            
            // Format v·ªã tr√≠ cho t√™n file
            if (positionForFile) {
                const positionFormatted = positionForFile
                    .toLowerCase()
                    .replace(/\s+/g, '-')  
                    .replace(/[^a-zA-Z0-9\-]/g, '')  
                    .replace(/\-+/g, '-')  
                    .replace(/^\-|\-$/g, ''); 
                
                if (positionFormatted) {
                    fileName += `_${positionFormatted}`;
                }
            }
            
            // Th√™m timestamp n·∫øu kh√¥ng c√≥ th√¥ng tin ng√†y (ƒë·ªÉ tr√°nh t√™n file tr√πng l·∫∑p)
            if (fileName.length < 20) {
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 10).replace(/-/g, '');
                if (!fileName.includes(timestamp)) {
                    fileName += `_${timestamp}`;
                }
            }
            
            return fileName + '.xlsx';
        }

        // X√≥a b·ªô l·ªçc
        function clearFilters() {
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            document.getElementById('positionFilter').value = '';
            document.getElementById('searchInput').value = '';
            
            if (allData.length > 0) {
                applyFilters();
                showStatus('ƒê√£ x√≥a t·∫•t c·∫£ b·ªô l·ªçc!', 'success');
            } else {
                showStatus('Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc khi x√≥a b·ªô l·ªçc!', 'loading');
            }
        }

        // Event listeners
        document.getElementById('fromDate').addEventListener('change', applyFilters);
        document.getElementById('toDate').addEventListener('change', applyFilters);
        document.getElementById('positionFilter').addEventListener('change', applyFilters);
        
        // Debounce search input
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        });

        // Kh·ªüi t·∫°o trang (ƒê√É B·ªî SUNG T·ª∞ ƒê·ªòNG T·∫¢I D·ªÆ LI·ªÜU)
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            loadData(); 
        });
        
    </script>
</body>
</html>
