<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xu·∫•t Excel - Ki·ªÉm k√™ ƒë∆°n h√†ng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: linear-gradient(135deg, #f6f9fc 0%, #ffffff 100%);
            border-bottom: 1px solid #e1e8ed;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select {
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
            transform: translateY(-2px);
        }

        .search-container {
            position: relative;
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 50px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 1.2rem;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.6);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }

        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.6);
        }

        .content {
            padding: 30px;
        }

        .status {
            padding: 15px 25px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: 500;
            display: none;
        }

        .status.loading {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #8b4513;
            display: block;
        }

        .status.success {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            color: #2d5016;
            display: block;
        }

        .status.error {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #8b0000;
            display: block;
            max-height: 400px;
            overflow-y: auto;
        }

        .status.error h3 {
            margin-bottom: 10px;
            color: #d32f2f;
        }

        .status.error h4 {
            margin: 15px 0 10px 0;
            color: #d32f2f;
        }

        .status.error ol {
            margin: 10px 0 10px 20px;
        }

        .status.error li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .data-table th {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-bottom: 2px solid #0288d1;
            white-space: nowrap;
        }

        .data-table th:hover {
            background: linear-gradient(135deg, #2196f3 0%, #03a9f4 100%);
            transform: translateY(-1px);
            transition: all 0.3s ease;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
            vertical-align: top;
        }

        .data-table tr:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .highlight {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .filter-group {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                justify-content: center;
            }
            
            .data-table {
                font-size: 0.8rem;
            }
            
            .data-table th, .data-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Xu·∫•t Excel - Ki·ªÉm k√™ ƒë∆°n h√†ng</h1>
            <p>Qu·∫£n l√Ω v√† xu·∫•t d·ªØ li·ªáu t·ª´ Google Sheets</p>
        </div>

        <div class="controls">
            <div class="filter-group">
                <div class="form-group">
                    <label for="fromDate">üìÖ T·ª´ ng√†y:</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="form-group">
                    <label for="toDate">üìÖ ƒê·∫øn ng√†y:</label>
                    <input type="date" id="toDate">
                </div>
                <div class="form-group">
                    <label for="positionFilter">üìç V·ªã tr√≠:</label>
                    <select id="positionFilter">
                        <option value="">-- T·∫•t c·∫£ v·ªã tr√≠ --</option>
                    </select>
                </div>
            </div>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç T√¨m ki·∫øm n·ªôi dung...">
                <span class="search-icon">üîç</span>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="loadData()">
                    <span id="loadText">üì• T·∫£i d·ªØ li·ªáu</span>
                </button>
                <button class="btn btn-success" onclick="exportToExcel()">
                    üì§ Xu·∫•t Excel
                </button>
                <button class="btn btn-warning" onclick="clearFilters()">
                    üîÑ X√≥a b·ªô l·ªçc
                </button>
            </div>
        </div>

        <div class="content">
            <div id="status" class="status"></div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">T·ªïng s·ªë b·∫£n ghi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="filteredRecords">0</div>
                    <div class="stat-label">B·∫£n ghi hi·ªÉn th·ªã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniquePositions">0</div>
                    <div class="stat-label">V·ªã tr√≠ kh√°c nhau</div>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table" id="dataTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>üìã Order KD</th>
                            <th>üîñ T√™n chi ti·∫øt</th>
                            <th>üìÅ S·ªë file</th>
                            <th>üìä SLL</th>
                            <th>üè∑Ô∏è QR code</th>
                            <th>üìç V·ªã tr√≠</th>
                            <th>üìù SL ki·ªÉm ƒë·∫øm</th>
                            <th>üì¶ T·ª´ th√πng</th>
                            <th>üì¶ ƒê·∫øn th√πng</th>
                            <th>‚úÖ Check QR</th>
                            <th>üí¨ Ghi ch√∫</th>
                            <th>üî¢ Code</th>
                            <th>üë§ H·ªç v√† t√™n</th>
                            <th>üìÖ Ng√†y nh·∫≠p</th>
                            <th>üîÑ Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1uWHw7ME46tF5bkB0vrUM-Ubi982k4l3sHuqYcy3dFF4';
        const API_KEY = 'AIzaSyCrC_DfD_DrpjzjO5ENvqTMHBA4FIDBiP0';
        const RANGE = 'Nh·∫≠p ƒë∆°n h√†ng ki·ªÉm k√™!A:O'; // T·ª´ c·ªôt A ƒë·∫øn O (15 c·ªôt)
        
        let allData = [];
        let filteredData = [];

        // Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh
        function setDefaultDates() {
            const today = new Date();
            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('fromDate').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('toDate').value = today.toISOString().split('T')[0];
        }

        // Hi·ªÉn th·ªã tr·∫°ng th√°i
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // T·∫£i d·ªØ li·ªáu t·ª´ Google Sheets API
        async function loadData() {
            const loadButton = document.querySelector('.btn-primary');
            const loadText = document.getElementById('loadText');
            
            loadButton.disabled = true;
            loadText.innerHTML = '<span class="loading-spinner"></span> ƒêang t·∫£i...';
            showStatus('ƒêang k·∫øt n·ªëi Google Sheets API...', 'loading');

            try {
                // Ch·ªâ s·ª≠ d·ª•ng Google Sheets API
                const data = await fetchGoogleSheetsData();
                
                if (!data || !data.values || data.values.length === 0) {
                    throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu trong b·∫£ng t√≠nh ho·∫∑c kh√¥ng th·ªÉ truy c·∫≠p');
                }

                // Ki·ªÉm tra header
                const headers = data.values[0];
                console.log('Headers t·ª´ Google Sheets:', headers);

                // B·ªè qua h√†ng ƒë·∫ßu ti√™n (header) v√† x·ª≠ l√Ω d·ªØ li·ªáu
                const rows = data.values.slice(1);
                
                allData = rows.map((row, index) => {
                    // ƒê·∫£m b·∫£o m·ªói row c√≥ ƒë·ªß 15 c·ªôt
                    while (row.length < 15) {
                        row.push('');
                    }
                    
                    return {
                        orderKD: row[0] || '',
                        tenChiTiet: row[1] || '',
                        soFile: row[2] || '',
                        sll: row[3] || '',
                        qrCode: row[4] || '',
                        viTri: row[5] || '',
                        slKiemDem: row[6] || '',
                        tuThung: row[7] || '',
                        denThung: row[8] || '',
                        checkQR: row[9] || '',
                        ghiChu: row[10] || '',
                        code: row[11] || '',
                        hoVaTen: row[12] || '',
                        ngayNhap: row[13] || '',
                        trangThai: row[14] || ''
                    };
                });

                // Lo·∫°i b·ªè c√°c d√≤ng tr·ªëng
                allData = allData.filter(row => 
                    Object.values(row).some(value => value && value.trim() !== '')
                );

                populatePositionFilter();
                applyFilters();
                showStatus(`‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng ${allData.length} b·∫£n ghi t·ª´ Google Sheets!`, 'success');
                
                // Hi·ªÉn th·ªã b·∫£ng v√† th·ªëng k√™
                document.getElementById('dataTable').style.display = 'table';
                document.getElementById('stats').style.display = 'grid';
                
            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
                showGoogleSheetsError(error);
            } finally {
                loadButton.disabled = false;
                loadText.innerHTML = 'üì• T·∫£i d·ªØ li·ªáu';
            }
        }

        // Fetch d·ªØ li·ªáu t·ª´ Google Sheets API
        async function fetchGoogleSheetsData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            
            console.log('ƒêang g·ªçi API:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', [...response.headers.entries()]);

            if (!response.ok) {
                const errorBody = await response.text();
                console.log('Error response body:', errorBody);
                
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorJson = JSON.parse(errorBody);
                    if (errorJson.error && errorJson.error.message) {
                        errorMessage += `: ${errorJson.error.message}`;
                    }
                } catch (e) {
                    errorMessage += `: ${errorBody}`;
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            console.log('D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:', {
                totalRows: data.values ? data.values.length : 0,
                firstRow: data.values ? data.values[0] : null
            });

            return data;
        }

        // Hi·ªÉn th·ªã l·ªói Google Sheets v·ªõi h∆∞·ªõng d·∫´n chi ti·∫øt
        function showGoogleSheetsError(error) {
            const status = document.getElementById('status');
            
            let errorHTML = `
                <div style="text-align: left;">
                    <h3>‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi Google Sheets</h3>
                    <p><strong>L·ªói:</strong> ${error.message}</p>
                    <br>
            `;

            if (error.message.includes('403')) {
                errorHTML += `
                    <h4>üîß Kh·∫Øc ph·ª•c l·ªói 403 (Forbidden):</h4>
                    <ol>
                        <li><strong>Ki·ªÉm tra API Key:</strong>
                            <ul>
                                <li>Truy c·∫≠p <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></li>
                                <li>ƒê·∫£m b·∫£o API key: <code>${API_KEY}</code> c√≤n hi·ªáu l·ª±c</li>
                                <li>Ki·ªÉm tra quota v√† usage limits</li>
                            </ul>
                        </li>
                        <li><strong>B·∫≠t Google Sheets API:</strong>
                            <ul>
                                <li>Trong Google Cloud Console, b·∫≠t "Google Sheets API"</li>
                                <li>ƒê·∫£m b·∫£o project ƒë√£ ƒë∆∞·ª£c billing enabled (n·∫øu c·∫ßn)</li>
                            </ul>
                        </li>
                        <li><strong>Ki·ªÉm tra quy·ªÅn truy c·∫≠p Sheet:</strong>
                            <ul>
                                <li>M·ªü Google Sheet: <a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}" target="_blank">M·ªü Sheet</a></li>
                                <li>Nh·∫•n "Share" ‚Üí "Anyone with the link can view"</li>
                                <li>Ho·∫∑c th√™m service account email v√†o sheet</li>
                            </ul>
                        </li>
                    </ol>
                `;
            } else if (error.message.includes('404')) {
                errorHTML += `
                    <h4>üîß Kh·∫Øc ph·ª•c l·ªói 404 (Not Found):</h4>
                    <ol>
                        <li><strong>Ki·ªÉm tra Sheet ID:</strong> <code>${SHEET_ID}</code></li>
                        <li><strong>Ki·ªÉm tra t√™n Sheet:</strong> ƒê·∫£m b·∫£o c√≥ sheet t√™n "Nh·∫≠p ƒë∆°n h√†ng ki·ªÉm k√™"</li>
                        <li><strong>Ki·ªÉm tra quy·ªÅn truy c·∫≠p:</strong> Sheet c√≥ th·ªÉ ƒë√£ b·ªã x√≥a ho·∫∑c kh√¥ng public</li>
                    </ol>
                `;
            } else {
                errorHTML += `
                    <h4>üîß C√°c b∆∞·ªõc ki·ªÉm tra:</h4>
                    <ol>
                        <li>Ki·ªÉm tra k·∫øt n·ªëi internet</li>
                        <li>Th·ª≠ refresh trang v√† load l·∫°i</li>
                        <li>Ki·ªÉm tra browser console ƒë·ªÉ xem l·ªói chi ti·∫øt</li>
                        <li>ƒê·∫£m b·∫£o CORS ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng</li>
                    </ol>
                `;
            }

            errorHTML += `
                    <br>
                    <h4>üìã Th√¥ng tin k·∫øt n·ªëi hi·ªán t·∫°i:</h4>
                    <ul>
                        <li><strong>Sheet ID:</strong> <code>${SHEET_ID}</code></li>
                        <li><strong>API Key:</strong> <code>${API_KEY.substring(0, 20)}...</code></li>
                        <li><strong>Range:</strong> <code>${RANGE}</code></li>
                        <li><strong>URL API:</strong> <a href="https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}" target="_blank">Test trong browser</a></li>
                    </ul>
                    <br>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <strong>üí° G·ª£i √Ω:</strong> Nh·∫•n v√†o link "Test trong browser" ·ªü tr√™n ƒë·ªÉ ki·ªÉm tra tr·ª±c ti·∫øp API response
                    </div>
                </div>
            `;

            status.innerHTML = errorHTML;
            status.className = 'status error';
        }

        // ƒêi·ªÅn d·ªØ li·ªáu v√†o dropdown v·ªã tr√≠
        function populatePositionFilter() {
            const positions = [...new Set(allData.map(item => item.viTri).filter(pos => pos))];
            const select = document.getElementById('positionFilter');
            
            // X√≥a c√°c option c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            positions.sort().forEach(position => {
                const option = document.createElement('option');
                option.value = position;
                option.textContent = position;
                select.appendChild(option);
            });
        }

        // √Åp d·ª•ng b·ªô l·ªçc
        function applyFilters() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const position = document.getElementById('positionFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredData = allData.filter(item => {
                // L·ªçc theo ng√†y
                if (fromDate && item.ngayNhap) {
                    const itemDate = new Date(item.ngayNhap);
                    const filterFromDate = new Date(fromDate);
                    if (itemDate < filterFromDate) return false;
                }
                
                if (toDate && item.ngayNhap) {
                    const itemDate = new Date(item.ngayNhap);
                    const filterToDate = new Date(toDate);
                    if (itemDate > filterToDate) return false;
                }

                // L·ªçc theo v·ªã tr√≠
                if (position && item.viTri !== position) return false;

                // T√¨m ki·∫øm
                if (searchTerm) {
                    const searchableText = Object.values(item).join(' ').toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }

                return true;
            });

            displayData();
            updateStats();
        }

        // Hi·ªÉn th·ªã d·ªØ li·ªáu trong b·∫£ng
        function displayData() {
            const tbody = document.getElementById('dataBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            tbody.innerHTML = '';

            filteredData.forEach(item => {
                const row = document.createElement('tr');
                
                const cells = [
                    item.orderKD, item.tenChiTiet, item.soFile, item.sll, item.qrCode,
                    item.viTri, item.slKiemDem, item.tuThung, item.denThung, item.checkQR,
                    item.ghiChu, item.code, item.hoVaTen, item.ngayNhap, item.trangThai
                ];

                cells.forEach(cellValue => {
                    const cell = document.createElement('td');
                    
                    if (searchTerm && cellValue.toLowerCase().includes(searchTerm)) {
                        cell.innerHTML = highlightText(cellValue, searchTerm);
                    } else {
                        cell.textContent = cellValue;
                    }
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        // Highlight text t√¨m ki·∫øm
        function highlightText(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats() {
            document.getElementById('totalRecords').textContent = allData.length;
            document.getElementById('filteredRecords').textContent = filteredData.length;
            
            const uniquePositions = new Set(filteredData.map(item => item.viTri).filter(pos => pos));
            document.getElementById('uniquePositions').textContent = uniquePositions.size;
        }

        // Xu·∫•t Excel
        function exportToExcel() {
            if (filteredData.length === 0) {
                showStatus('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
                return;
            }

            try {
                // T·∫°o workbook
                const wb = XLSX.utils.book_new();
                
                // T·∫°o header
                const headers = [
                    'Order KD', 'T√™n chi ti·∫øt', 'S·ªë file', 'SLL', 'QR code',
                    'V·ªã tr√≠', 'SL ki·ªÉm ƒë·∫øm', 'T·ª´ th√πng', 'ƒê·∫øn th√πng', 'Check QR code',
                    'Ghi ch√∫', 'Code', 'H·ªç v√† t√™n', 'Ng√†y nh·∫≠p', 'Tr·∫°ng th√°i'
                ];

                // T·∫°o d·ªØ li·ªáu cho worksheet
                const wsData = [headers];
                
                filteredData.forEach(item => {
                    wsData.push([
                        item.orderKD, item.tenChiTiet, item.soFile, item.sll, item.qrCode,
                        item.viTri, item.slKiemDem, item.tuThung, item.denThung, item.checkQR,
                        item.ghiChu, item.code, item.hoVaTen, item.ngayNhap, item.trangThai
                    ]);
                });

                // T·∫°o worksheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Thi·∫øt l·∫≠p ƒë·ªô r·ªông c·ªôt
                const colWidths = headers.map(() => ({ wch: 15 }));
                ws['!cols'] = colWidths;

                // Th√™m worksheet v√†o workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Ki·ªÉm k√™ ƒë∆°n h√†ng');

                // T·∫°o t√™n file d·ª±a theo b·ªô l·ªçc
                const filename = generateFileName();

                // Xu·∫•t file
                XLSX.writeFile(wb, filename);
                
                showStatus(`üì§ ƒê√£ xu·∫•t th√†nh c√¥ng ${filteredData.length} b·∫£n ghi v√†o file "${filename}"!`, 'success');
                
            } catch (error) {
                console.error('L·ªói khi xu·∫•t Excel:', error);
                showStatus(`L·ªói khi xu·∫•t Excel: ${error.message}`, 'error');
            }
        }

        // T·∫°o t√™n file d·ª±a theo ng√†y nh·∫≠p th·ª±c t·∫ø v√† v·ªã tr√≠ t·ª´ d·ªØ li·ªáu
        function generateFileName() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const position = document.getElementById('positionFilter').value;
            
            let fileName = 'Kiem_ke_don_hang';
            
            // L·∫•y ng√†y nh·∫≠p t·ª´ d·ªØ li·ªáu th·ª±c t·∫ø
            if (filteredData.length > 0) {
                const dates = filteredData
                    .map(item => item.ngayNhap)
                    .filter(date => date && date.trim() !== '')
                    .map(date => {
                        // X·ª≠ l√Ω nhi·ªÅu format ng√†y
                        if (date.includes('/')) {
                            // Format dd/mm/yyyy -> yyyy-mm-dd
                            const parts = date.split('/');
                            if (parts.length === 3) {
                                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            }
                        } else if (date.includes('-')) {
                            // Format yyyy-mm-dd ho·∫∑c dd-mm-yyyy
                            const parts = date.split('-');
                            if (parts.length === 3) {
                                if (parts[0].length === 4) {
                                    return date; // ƒê√£ ƒë√∫ng format yyyy-mm-dd
                                } else {
                                    return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                                }
                            }
                        }
                        return date;
                    })
                    .sort();

                if (dates.length > 0) {
                    const firstDate = dates[0];
                    const lastDate = dates[dates.length - 1];
                    
                    // Format ng√†y cho t√™n file (yyyymmdd)
                    const formatDateForFile = (dateStr) => {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            return date.toISOString().slice(0, 10).replace(/-/g, '');
                        }
                        return dateStr.replace(/[-/]/g, '');
                    };

                    const firstFormatted = formatDateForFile(firstDate);
                    const lastFormatted = formatDateForFile(lastDate);
                    
                    if (firstFormatted === lastFormatted) {
                        fileName += `_${firstFormatted}`;
                    } else {
                        fileName += `_${firstFormatted}_den_${lastFormatted}`;
                    }
                }
            } else if (fromDate && toDate) {
                // Fallback v·ªÅ b·ªô l·ªçc n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
                const fromFormatted = fromDate.replace(/-/g, '');
                const toFormatted = toDate.replace(/-/g, '');
                if (fromFormatted === toFormatted) {
                    fileName += `_${fromFormatted}`;
                } else {
                    fileName += `_${fromFormatted}_den_${toFormatted}`;
                }
            }
            
            // L·∫•y v·ªã tr√≠ t·ª´ d·ªØ li·ªáu ho·∫∑c b·ªô l·ªçc
            let positionForFile = '';
            if (position) {
                // S·ª≠ d·ª•ng v·ªã tr√≠ t·ª´ b·ªô l·ªçc
                positionForFile = position;
            } else if (filteredData.length > 0) {
                // L·∫•y v·ªã tr√≠ ph·ªï bi·∫øn nh·∫•t t·ª´ d·ªØ li·ªáu
                const positions = filteredData
                    .map(item => item.viTri)
                    .filter(pos => pos && pos.trim() !== '');
                
                if (positions.length > 0) {
                    // ƒê·∫øm t·∫ßn su·∫•t xu·∫•t hi·ªán c·ªßa m·ªói v·ªã tr√≠
                    const positionCount = {};
                    positions.forEach(pos => {
                        positionCount[pos] = (positionCount[pos] || 0) + 1;
                    });
                    
                    // L·∫•y v·ªã tr√≠ xu·∫•t hi·ªán nhi·ªÅu nh·∫•t
                    positionForFile = Object.keys(positionCount).reduce((a, b) => 
                        positionCount[a] > positionCount[b] ? a : b
                    );
                }
            }
            
            // Format v·ªã tr√≠ cho t√™n file
            if (positionForFile) {
                const positionFormatted = positionForFile
                    .toLowerCase()
                    .replace(/\s+/g, '-')  // Thay space b·∫±ng d·∫•u g·∫°ch ngang
                    .replace(/[^a-zA-Z0-9\-]/g, '')  // Gi·ªØ l·∫°i ch·ªØ, s·ªë v√† d·∫•u g·∫°ch ngang
                    .replace(/\-+/g, '-')  // Lo·∫°i b·ªè d·∫•u g·∫°ch ngang li√™n ti·∫øp
                    .replace(/^\-|\-$/g, ''); // Lo·∫°i b·ªè d·∫•u g·∫°ch ngang ·ªü ƒë·∫ßu/cu·ªëi
                
                if (positionFormatted) {
                    fileName += `_${positionFormatted}`;
                }
            }
            
            // Th√™m timestamp n·∫øu kh√¥ng c√≥ th√¥ng tin ng√†y
            if (!fileName.includes('20')) {
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 10).replace(/-/g, '');
                fileName += `_${timestamp}`;
            }
            
            return fileName + '.xlsx';
        }

        // X√≥a b·ªô l·ªçc
        function clearFilters() {
            document.getElementById('fromDate').value = '';
            document.getElementById('toDate').value = '';
            document.getElementById('positionFilter').value = '';
            document.getElementById('searchInput').value = '';
            
            if (allData.length > 0) {
                applyFilters();
                showStatus('ƒê√£ x√≥a t·∫•t c·∫£ b·ªô l·ªçc!', 'success');
            }
        }

        // Event listeners
        document.getElementById('fromDate').addEventListener('change', applyFilters);
        document.getElementById('toDate').addEventListener('change', applyFilters);
        document.getElementById('positionFilter').addEventListener('change', applyFilters);
        
        // Debounce search input
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        });

        // Kh·ªüi t·∫°o trang
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            showStatus('S·∫µn s√†ng t·∫£i d·ªØ li·ªáu. Nh·∫•n "T·∫£i d·ªØ li·ªáu" ƒë·ªÉ b·∫Øt ƒë·∫ßu.', 'loading');
        });
    </script>
</body>
</html>
